<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PULSE: Personal Unified Lifestyle and Smart Empowerment</title>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Load Lucide Icons -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <!-- Load Custom Styles -->
    <style>
        /* Base Theme Variables (Dark - Default) */
        :root {
            --bg-primary: #0d1117;
            --bg-header: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #9ca3af;
            --card-bg: #161b22;
            --card-hover-bg: #1f2937;
            --input-bg: #1f2937;
            --input-border: #374151;
            --modal-bg: #1f2937;
            --chat-ai-bg: #374151;
            --chat-bg-container: #1e2531;
            --accent-color: #2dd4bf;
            /* Teal */
            --accent-color-hover: #14b8a6;
            --accent-text: #2dd4bf;
        }

        /* Light Theme Overrides */
        [data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-header: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --card-bg: #ffffff;
            --card-hover-bg: #f3f4f6;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --modal-bg: #ffffff;
            --chat-ai-bg: #e5e7eb;
            --chat-bg-container: #f9fafb;
            --text-white-override: #1f2937;
        }

        /* Apply variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .header-bg {
            background-color: var(--bg-header);
            transition: background-color 0.3s;
        }

        /* Dynamic Accent Colors */
        .accent-teal {
            color: var(--accent-text);
        }

        .color-accent-text {
            color: var(--accent-text);
        }

        .color-bg-accent {
            background-color: var(--accent-color);
        }

        .color-bg-accent-hover:hover {
            background-color: var(--accent-color-hover);
        }

        /* Enhanced Card Style */
        .card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--input-border);
        }

        .card:hover {
            transform: scale(1.01);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
        }

        /* Single Page App View Switching */
        .view {
            display: none;
            min-height: calc(100vh - 80px);
            padding-bottom: 5rem;
        }

        .view.active {
            display: block;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--input-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Chatbot fixed button */
        .chatbot-fixed {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
            cursor: pointer;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--modal-bg);
            border-radius: 0.75rem;
            max-width: 90%;
            width: 450px;
            padding: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7);
            color: var(--text-primary);
            animation: fadeIn 0.3s ease-out;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Loading spinner */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-lg {
            max-width: 90%;
            width: 700px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat view styles */
        .chat-container {
            height: 65vh;
            overflow-y: auto;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: var(--chat-bg-container);
            transition: background-color 0.3s;
        }

        .message {
            margin-bottom: 0.75rem;
            display: flex;
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-bubble {
            background-color: var(--accent-color);
            color: black;
            padding: 0.6rem 1rem;
            border-radius: 1.2rem 1.2rem 0.4rem 1.2rem;
            max-width: 75%;
            font-weight: 500;
        }

        .ai-bubble {
            background-color: var(--chat-ai-bg);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 1.2rem 1.2rem 1.2rem 0.4rem;
            max-width: 75%;
        }

        /* AI Typing Indicator */
        .ai-typing {
            display: flex;
            align-items: center;
            padding: 0.6rem 1rem;
            background-color: var(--chat-ai-bg);
            border-radius: 1.2rem 1.2rem 1.2rem 0.4rem;
            max-width: fit-content;
        }

        /* Keyframe for subtle border animation */
        @keyframes pulse-border {
            0% {
                border-color: #2dd4bf30;
            }

            50% {
                border-color: #2dd4bf70;
            }

            100% {
                border-color: #2dd4bf30;
            }
        }

        .animated-border-card {
            animation: pulse-border 3s infinite ease-in-out;
        }

        /* Custom input style for forms with icons */
        .input-group {
            position: relative;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding-left: 2.75rem !important;
            transition: border-color 0.2s;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 1px var(--accent-color);
        }

        .input-group i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            z-index: 10;
        }

        /* Adjust icon position for labels/selects where 50% doesn't work well */
        .input-group label+i {
            top: calc(50% + 0.5rem);
        }

        .input-group select+i {
            top: calc(50% + 0.5rem);
        }

        /* Responsive adjustments for Dashboard Score Breakdown */
        .score-item {
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            background-color: var(--card-hover-bg);
            transition: background-color 0.3s;
        }

        @media (min-width: 768px) {
            .score-item {
                padding: 1rem;
            }
        }

        /* Activity Dot Pulse Animation */
        @keyframes activity-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(45, 212, 191, 0.7);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(45, 212, 191, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(45, 212, 191, 0);
            }
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            background-color: var(--accent-color);
            border-radius: 50%;
            animation: activity-pulse 2s infinite;
            margin-right: 8px;
        }

        /* Tool Card Minimum Height for consistent grid look */
        .tool-card {
            min-height: 180px;
        }

        /* Voice recognition active state */
        .mic-active {
            background-color: #f87171 !important;
            color: black !important;
            box-shadow: 0 0 10px #f87171;
            transform: scale(1.1);
        }

        /* Text color overrides for compatibility with dynamic theme colors */
        [data-theme="light"] .text-white {
            color: var(--text-primary) !important;
        }

        [data-theme="light"] .text-gray-400 {
            color: var(--text-secondary) !important;
        }

        [data-theme="light"] .bg-gray-700 {
            background-color: var(--card-hover-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="light"] .hover\:bg-gray-700:hover {
            background-color: var(--card-hover-bg) !important;
        }

        [data-theme="light"] .bg-gray-800 {
            background-color: #f3f4f6 !important;
            color: var(--text-primary) !important;
        }

        [data-theme="light"] .border-gray-700 {
            border-color: var(--input-border) !important;
        }
    </style>
</head>

<body>

    <!-- Header Navigation -->
    <header class="header-bg sticky top-0 z-40 shadow-xl border-b" style="border-color: var(--input-border);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo & Text -->
                <a href="/" class="flex items-center space-x-2 flex-shrink-0" onclick="showView('home')"
                    aria-label="Go to Home">
                    <i data-lucide="activity" class="color-accent-text h-8 w-8"></i>
                    <div class="flex flex-col items-start leading-none">
                        <span class="text-2xl font-extrabold" style="color: var(--text-primary);">PULSE</span>
                        <span class="text-xs text-gray-400 font-light mt-0.5 hidden md:block">Personal Unified
                            Lifestyle</span>
                        <span class="text-xs text-gray-400 font-light hidden md:block">Smart Empowerment</span>
                    </div>
                </a>

                <!-- Navigation Links (Desktop) -->
                <nav class="hidden md:flex items-center space-x-6 text-sm font-medium">

                    <div class="flex items-center space-x-4">
                        <a href="/" class="nav-link hover:text-white transition duration-150 text-gray-400"
                            data-view="home">Home</a>
                        <a href="/dashboard" class="nav-link hover:text-white transition duration-150 text-gray-400"
                            data-view="dashboard">Dashboard</a>
                        <a href="/booking" class="nav-link hover:text-white transition duration-150 text-gray-400"
                            data-view="booking">Booking</a>
                        <a href="/tools" class="nav-link hover:text-white transition duration-150 text-gray-400"
                            data-view="tools">Tools</a>
                        <a href="/environmental" class="nav-link hover:text-white transition duration-150 text-gray-400"
                            data-view="environmental">Environment</a>
                        <a href="/wellness" class="nav-link hover:text-white transition duration-150 text-gray-400"
                            data-view="wellness">Wellness</a>
                        <a href="/connect" class="nav-link hover:text-white transition duration-150 text-gray-400"
                            data-view="connect">Connect</a>
                    </div>
                    <button onclick="showView('subscription')"
                        class="px-3 py-1 text-sm font-semibold rounded-full bg-yellow-600 hover:bg-yellow-500 text-black transition duration-150 shadow-md flex items-center space-x-1 transform hover:scale-[1.05]">
                        <i data-lucide="crown" class="w-4 h-4"></i><span>Premium</span>
                    </button>
                </nav>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-6">

                    <div class="flex items-center space-x-4">

                        <!-- Settings Button -->
                        <button onclick="showSettingsModal()" title="Settings"
                            class="p-2 rounded-full text-gray-400 hover:bg-gray-700 transition duration-150 transform hover:scale-110">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                        </button>

                        <!-- Quick link to Device Hub -->
                        <button onclick="showDeviceLinkModal()" title="Link Smart Device"
                            class="p-2 rounded-full text-green-400 hover:bg-gray-700 transition duration-150 transform hover:scale-110 hidden sm:block">
                            <i data-lucide="watch" class="w-5 h-5"></i>
                        </button>

                        <!-- SOS Button -->
                        <button onclick="showMentalHealthCrisisModal()" title="Emergency Crisis Intervention"
                            class="flex-shrink-0 bg-red-600 hover:bg-red-700 p-2 rounded-full transition duration-150 shadow-lg transform hover:scale-110"
                            aria-label="Emergency Crisis Intervention">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>

                    <!-- User/Auth Group -->
                    <div class="hidden md:flex items-center space-x-6">
                        <!-- User Greeting and Logout (Dynamically Managed) -->
                        <div id="user-info" class="hidden items-center space-x-3 text-sm font-medium">
                            <span id="user-greeting" class="text-gray-400 font-semibold">Welcome Back!</span>
                            <button onclick="signOutUser()"
                                class="flex-shrink-0 px-3 py-1 text-xs font-semibold rounded-full text-red-300 border border-red-600 hover:bg-red-900 transition duration-150"
                                aria-label="Sign Out">
                                Sign Out
                            </button>
                        </div>

                        <!-- Login/Sign Up Buttons (Dynamically Managed) -->
                        <div id="auth-buttons" class="flex items-center space-x-4">
                            <button onclick="showAuthModal('login')"
                                class="px-4 py-2 text-sm font-semibold rounded-full text-gray-200 border border-gray-600 hover:bg-gray-700 transition duration-150 shadow-md transform hover:scale-[1.05]"
                                aria-label="Login">
                                Login
                            </button>
                            <button onclick="showAuthModal('signup')"
                                class="color-bg-accent color-bg-accent-hover text-black px-4 py-2 text-sm font-bold rounded-full transition duration-150 shadow-lg transform hover:scale-[1.05]"
                                aria-label="Sign Up">
                                Sign Up
                            </button>
                        </div>
                    </div>

                    <!-- Mobile Menu Button -->
                    <button class="md:hidden p-2 rounded-lg hover:bg-gray-700" onclick="toggleMobileMenu()"
                        aria-label="Toggle Mobile Menu">
                        <i data-lucide="menu" class="w-6 h-6 text-gray-300"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu (Hidden by default) -->
        <div id="mobile-menu" class="hidden md:hidden pb-4 px-4 header-bg border-t"
            style="border-color: var(--input-border);">
            <div class="flex flex-col space-y-2 pt-2 text-center">
                <a href="/" onclick="showView('home'); toggleMobileMenu();"
                    class="py-2 text-gray-300 hover:bg-gray-700 rounded-md">Home</a>
                <a href="/dashboard" onclick="showView('dashboard'); toggleMobileMenu();"
                    class="py-2 text-gray-300 hover:bg-gray-700 rounded-md">Dashboard</a>
                <a href="/booking" onclick="showView('booking'); toggleMobileMenu();"
                    class="py-2 text-gray-300 hover:bg-gray-700 rounded-md">Booking</a>
                <a href="/tools" onclick="showView('tools'); toggleMobileMenu();"
                    class="py-2 text-gray-300 hover:bg-gray-700 rounded-md">Tools</a>
                <a href="/environmental" onclick="showView('environmental'); toggleMobileMenu();"
                    class="py-2 text-gray-300 hover:bg-gray-700 rounded-md">Environmental</a>
                <a href="/wellness" onclick="showView('wellness'); toggleMobileMenu();"
                    class="py-2 text-gray-300 hover:bg-gray-700 rounded-md">Wellness</a>
                <a href="/connect" onclick="showView('connect'); toggleMobileMenu();"
                    class="py-2 text-gray-300 hover:bg-gray-700 rounded-md">Connect</a>
                <a href="" onclick="showView('subscription'); toggleMobileMenu();"
                    class="py-2 text-yellow-500 hover:bg-gray-700 rounded-md flex items-center justify-center space-x-2">
                    <i data-lucide="crown" class="w-4 h-4 text-yellow-500"></i><span>Premium</span>
                </a>
                <button onclick="showAuthModal('login'); toggleMobileMenu();"
                    class="py-2 text-gray-300 hover:bg-gray-700 rounded-md border-t border-gray-800 mt-2">Login</button>
                <button onclick="showAuthModal('signup'); toggleMobileMenu();"
                    class="color-bg-accent color-bg-accent-hover text-black font-semibold rounded-md">Sign Up</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Home View -->
        <div id="home-view" class="view active">
            <section class="text-center pt-16 pb-20 relative overflow-hidden">
                <!-- Background Blob/Gradient Effect -->
                <div class="absolute inset-0 z-0 opacity-10"
                    style="background: radial-gradient(circle at 10% 90%, #2dd4bf50, transparent 50%), radial-gradient(circle at 90% 10%, #4f46e550, transparent 50);">
                </div>

                <div class="relative z-10">
                    <h1 class="text-5xl md:text-7xl font-extrabold mb-4 leading-tight"
                        style="color: var(--text-primary);">
                        PULSE: Achieve Your Peak <span class="accent-teal block sm:inline">Wellness Potential.</span>
                    </h1>
                    <p class="text-xl text-gray-400 mb-8 max-w-4xl mx-auto">
                        Unify your health tracking, connect with experts, and leverage AI insights for smarter,
                        healthier living.
                    </p>

                    <!-- CTA Buttons -->
                    <div class="flex justify-center space-x-4 mb-16">
                        <button onclick="showAuthModal('signup')"
                            class="color-bg-accent color-bg-accent-hover text-black font-extrabold py-3 px-8 rounded-full text-lg transition duration-300 shadow-xl transform hover:scale-105">
                            Start Your Free Trial
                        </button>
                        <button onclick="showView('dashboard')"
                            class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-full text-lg transition duration-300 shadow-xl transform hover:scale-105">
                            View Demo Dashboard
                        </button>
                    </div>

                    <!-- Enhanced Wellness Score Teaser (Visible only if logged in) -->
                    <div id="home-wellness-teaser" onclick="showView('dashboard')"
                        class="cursor-pointer card p-6 md:p-8 inline-block transform hover:scale-[1.03] transition duration-300 border-2 border-accent-teal shadow-2xl w-full max-w-2xl mt-10 animated-border-card"
                        style="display: none;">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <i data-lucide="monitor-dot" class="h-10 w-1- color-accent-text"></i>
                                <div class="text-left">
                                    <p class="text-sm font-semibold text-gray-400 uppercase">Your Live Insight</p>
                                    <h2 class="text-3xl font-bold" style="color: var(--text-primary);">Wellness Score:
                                        <span class="color-accent-text" id="home-score-display">86/100</span>
                                    </h2>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-500 text-sm hidden sm:block">Excellent Activity Score. <span
                                        class="font-bold" style="color: var(--text-primary);">Click for Weekly
                                        Report.</span></p>
                                <i data-lucide="chevron-right" class="h-6 w-6 text-gray-400 inline-block"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Grid Preview -->
                    <div class="mt-20 grid grid-cols-2 md:grid-cols-4 gap-6 text-center max-w-6xl mx-auto">
                        <div onclick="openPlanner('Nutrition')"
                            class="cursor-pointer p-4 card hover:border-accent-teal border border-transparent transition duration-300">
                            <i data-lucide="apple" class="h-8 w-8 mx-auto color-accent-text mb-2"></i>
                            <p class="text-sm font-semibold" style="color: var(--text-primary);">Nutrition Plans</p>
                        </div>
                        <div onclick="showView('environmental')"
                            class="cursor-pointer p-4 card hover:border-accent-teal border border-transparent transition duration-300">
                            <i data-lucide="cloud-fog" class="h-8 w-8 mx-auto text-indigo-400 mb-2"></i>
                            <p class="text-sm font-semibold" style="color: var(--text-primary);">Environment</p>
                        </div>
                        <div onclick="showView('wellness')"
                            class="cursor-pointer p-4 card hover:border-accent-teal border border-transparent transition duration-300">
                            <i data-lucide="dumbbell" class="h-8 w-8 mx-auto text-pink-400 mb-2"></i>
                            <p class="text-sm font-semibold" style="color: var(--text-primary);">Wellness Studio</p>
                        </div>
                        <div onclick="showView('booking')"
                            class="cursor-pointer p-4 card hover:border-accent-teal border border-transparent transition duration-300">
                            <i data-lucide="calendar-check" class="h-8 w-8 mx-auto color-accent-text mb-2"></i>
                            <p class="text-sm font-semibold" style="color: var(--text-primary);">Bookings</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <h2 class="text-4xl font-bold mb-6" style="color: var(--text-primary);">Your Unified Dashboard</h2>
            <p class="text-gray-400 mb-8">Personalized metrics, goals, and progress visualized in real-time.</p>

            <!-- AUTH CHECKER -->
            <div id="dashboard-auth-prompt" class="p-10 card text-center space-y-4">
                <i data-lucide="lock" class="w-10 h-10 mx-auto text-yellow-400"></i>
                <h3 class="text-xl font-bold" style="color: var(--text-primary);">Access Denied</h3>
                <p class="text-gray-400">Please log in or sign up to view your personalized health dashboard and
                    protected data.</p>
                <button onclick="showAuthModal('login')"
                    class="color-bg-accent color-bg-accent-hover text-black px-6 py-2 rounded-full font-bold transition duration-150">Login
                    / Sign Up</button>
            </div>
            <div id="dashboard-content" class="space-y-6">
                <!-- Dashboard Actions -->
                <div class="flex flex-wrap gap-3 mb-8">
                    <button onclick="showEditDataModal()"
                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition duration-150 flex items-center space-x-2 transform hover:scale-[1.03]">
                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                        <span>Edit Health Data</span>
                    </button>
                    <button onclick="undoChangeHandler()"
                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition duration-150 flex items-center space-x-2 transform hover:scale-[1.03]">
                        <i data-lucide="undo-2" class="w-4 h-4"></i>
                        <span>Undo Last Change</span>
                    </button>
                    <button onclick="showManualDataModal()"
                        class="color-bg-accent color-bg-accent-hover text-black rounded-lg text-sm font-bold transition duration-150 flex items-center space-x-2 transform hover:scale-[1.03]">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Add Data Manually</span>
                    </button>
                    <button onclick="showDeviceLinkModal()"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold transition duration-150 flex items-center space-x-2 transform hover:scale-[1.03]">
                        <i data-lucide="watch" class="w-4 h-4"></i>
                        <span>Device Hub</span>
                    </button>
                </div>

                <!-- Wellness Score Overview (Dynamic Score) -->
                <div class="card p-6 mb-8 border-l-4 border-accent-teal shadow-2xl">
                    <h3 class="text-2xl font-bold flex items-center space-x-3 mb-4" style="color: var(--text-primary);">
                        <i data-lucide="gauge" class="w-7 h-7 color-accent-text"></i>
                        <span>Overall Wellness Score: <span id="overall-score"
                                class="text-5xl font-extrabold color-accent-text">88</span><span
                                class="text-2xl text-gray-400">/100</span></span>
                    </h3>
                    <p class="text-gray-400 mb-4">A breakdown of your core health dimensions this week.</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="score-item rounded-lg">
                            <p id="score-activity" class="text-2xl font-extrabold text-green-400">92</p>
                            <p class="text-sm text-gray-400">Activity</p>
                        </div>
                        <div class="score-item rounded-lg">
                            <p id="score-sleep" class="text-2xl font-extrabold text-yellow-400">85</p>
                            <p class="text-sm text-gray-400">Sleep</p>
                        </div>
                        <div class="score-item rounded-lg">
                            <p id="score-stress" class="text-2xl font-extrabold text-red-400">79</p>
                            <p class="text-sm text-gray-400">Stress</p>
                        </div>
                        <div class="score-item rounded-lg">
                            <p id="score-nutrition" class="text-2xl font-extrabold text-blue-400">95</p>
                            <p class="text-sm text-gray-400">Nutrition</p>
                        </div>
                    </div>
                    <button onclick="showDeepDiveModal()"
                        class="mt-4 w-full text-center text-sm font-bold color-accent-text hover:text-teal-400 transition duration-150">
                        View Deep Dive Analysis
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Col 1 (2/3 width) - Charts and Activity Feed -->
                    <div class="lg:col-span-2 space-y-6">

                        <!-- Progress Report Card (Chart Area) -->
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                                style="color: var(--text-primary);">
                                <i data-lucide="bar-chart-3" class="w-6 h-6 color-accent-text"></i>
                                <span>Weekly Performance Chart</span>
                            </h3>
                            <!-- CHART.JS IMPLEMENTATION -->
                            <div style="height: 300px;">
                                <canvas id="weeklyPerformanceChart"></canvas>
                            </div>
                            <!-- END CHART.JS IMPLEMENTATION -->
                            <div class="mt-4 flex justify-between items-center text-sm text-gray-400">
                                <p>Data Range: Last 7 Days</p>
                                <button onclick="generateHealthReport()"
                                    class="color-accent-text hover:text-teal-400 font-medium transform hover:scale-[1.05]">Generate
                                    Detailed Report</button>
                            </div>
                        </div>

                        <!-- Recent Activity Feed (With Activity Dot) -->
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                                style="color: var(--text-primary);">
                                <div id="activity-dot" class="activity-dot"></div>
                                <i data-lucide="bolt" class="w-6 h-6 color-accent-text"></i>
                                <span>Recent Activity Feed</span>
                            </h3>
                            <ul class="space-y-3">
                                <!-- Activities populated by JS -->
                            </ul>
                            <button
                                onclick="showModal('Activity History', 'Loading complete history of your logged activities and device syncs.','View All')"
                                class="mt-4 w-full text-sm font-bold color-accent-text hover:text-teal-400 transform hover:scale-[1.05]">
                                View Full History
                            </button>
                        </div>

                    </div>

                    <!-- Col 2 (1/3 width) - Goals, Reminders, and Medication Monitoring -->
                    <div class="lg:col-span-1 space-y-6">

                        <!-- Medication Adherence -->
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                                style="color: var(--text-primary);">
                                <i data-lucide="pills" class="w-6 h-6 text-orange-400"></i>
                                <span>Medication Adherence</span>
                            </h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-medium" style="color: var(--text-primary);">Weekly Adherence
                                        Rate</span>
                                    <span class="text-orange-400 font-bold">88%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-orange-400 h-2.5 rounded-full transition-all duration-500"
                                        style="width: 88%"></div>
                                </div>
                                <p class="text-xs text-gray-500 pt-2">Next dose: Metformin at 8:00 AM</p>
                            </div>
                            <button onclick="showMedicationAdherenceModal()"
                                class="mt-4 w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                                Manage Doses & Reminders
                            </button>
                        </div>

                        <!-- Goals Card -->
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                                style="color: var(--text-primary);">
                                <i data-lucide="target" class="w-6 h-6 color-accent-text"></i>
                                <span>Goal Progress</span>
                            </h3>
                            <div class="space-y-4">
                                <!-- Goal content populated by JS -->
                            </div>
                            <button onclick="showGoalManagementModal()"
                                class="mt-4 w-full text-sm font-bold color-accent-text hover:text-teal-400 transform hover:scale-[1.05]">
                                Customize Goals
                            </button>
                        </div>

                        <!-- Quick Link to Environmental -->
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                                style="color: var(--text-primary);">
                                <i data-lucide="cloud-fog" class="w-6 h-6 text-indigo-400"></i>
                                <span>Environmental Quick Link</span>
                            </h3>
                            <p class="text-gray-400 mb-4 text-sm">View real-time air quality, pollen, and UV data.
                            </p>
                            <button onclick="showView('environmental')"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                                Go to Environmental Health
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription & Store View -->
        <div id="subscription-view" class="view">
            <h2 class="text-4xl font-bold mb-6" style="color: var(--text-primary);">PULSE Premium & Store</h2>
            <p class="text-gray-400 mb-8">Access all platform features with Premium, or purchase our smart devices.</p>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Subscription Plans -->
                <div class="card p-6">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                        style="color: var(--text-primary);">
                        <i data-lucide="crown" class="w-7 h-7 text-yellow-500"></i>
                        <span>PULSE Subscription Plans</span>
                    </h3>
                    <p class="text-gray-400 mb-6">Choose the plan that fits your health monitoring needs.</p>

                    <div class="space-y-4">
                        <!-- Basic Plan -->
                        <div
                            class="score-item p-4 rounded-lg border-l-4 border-gray-500 flex justify-between items-center">
                            <div>
                                <p class="font-bold" style="color: var(--text-primary);">Basic Access</p>
                                <p class="text-xl font-extrabold" style="color: var(--text-primary);">₹499<span
                                        class="text-sm font-normal text-gray-400">/month</span></p>
                            </div>
                            <button onclick="makeSubscriptionPayment('Basic', 499)"
                                class="color-bg-accent color-bg-accent-hover text-black font-bold py-2 px-4 rounded-lg transition duration-150">
                                Subscribe
                            </button>
                        </div>

                        <!-- Moderate Plan -->
                        <div
                            class="score-item p-4 rounded-lg border-l-4 border-indigo-400 flex justify-between items-center">
                            <div>
                                <p class="font-bold" style="color: var(--text-primary);">Moderate Access</p>
                                <p class="text-xl font-extrabold" style="color: var(--text-primary);">₹999<span
                                        class="text-sm font-normal text-gray-400">/month</span></p>
                            </div>
                            <button onclick="makeSubscriptionPayment('Moderate', 999)"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                                Subscribe
                            </button>
                        </div>

                        <!-- All-Access Plan (Highlighted) -->
                        <div
                            class="score-item p-4 rounded-lg border-l-4 border-yellow-500 flex justify-between items-center shadow-lg">
                            <div>
                                <p class="font-bold text-yellow-500">All-Access Premium</p>
                                <p class="text-xl font-extrabold text-yellow-500">₹1999<span
                                        class="text-sm font-normal text-gray-400">/month</span></p>
                            </div>
                            <button onclick="makeSubscriptionPayment('Premium', 1999)"
                                class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg transition duration-150">
                                Subscribe
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PULSE Smart Fitness Band -->
                <div class="card p-6">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                        style="color: var(--text-primary);">
                        <i data-lucide="hard-hat" class="w-7 h-7 text-green-400"></i>
                        <span>PULSE Smart Fitness Band</span>
                    </h3>
                    <p class="text-gray-400 mb-6">The ultimate companion for real-time, accurate health monitoring,
                        fully integrated with your PULSE dashboard.</p>

                    <ul class="space-y-3 text-sm mb-6">
                        <li class="flex items-center space-x-2 text-gray-300"><i data-lucide="heart-pulse"
                                class="w-4 h-4 text-red-400"></i><span>24/7 ECG & Continuous Heart Rate
                                Monitoring</span></li>
                        <li class="flex items-center space-x-2 text-gray-300"><i data-lucide="moon"
                                class="w-4 h-4 text-indigo-400"></i><span>Advanced Sleep Stage Analysis (REM, Deep,
                                Light)</span></li>
                        <li class="flex items-center space-x-2 text-gray-300"><i data-lucide="scan"
                                class="w-4 h-4 text-yellow-400"></i><span>Real-time Blood Oxygen (SpO2) Tracking</span>
                        </li>
                        <li class="flex items-center space-x-2 text-gray-300"><i data-lucide="clock"
                                class="w-4 h-4 text-yellow-500"></i><span>5 months free Pro Plan subscription
                                included</span></li>
                        <li class="flex items-center space-x-2 text-gray-300"><i data-lucide="battery-charging"
                                class="w-4 h-4 text-green-400"></i><span>10-Day Long-Life Battery</span></li>
                    </ul>

                    <div
                        class="flex justify-between items-center bg-gray-700/50 p-3 rounded-lg border border-gray-600 mb-4">
                        <span class="text-sm text-gray-300">Price:</span>
                        <span class="text-2xl font-extrabold text-green-400">₹4,999</span>
                    </div>

                    <button onclick="simulateBandPurchase()"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        <span>Buy Now & Auto-Connect</span>
                    </button>
                </div>
            </div>
        </div>


        <!-- Booking View -->
        <div id="booking-view" class="view">
            <h2 class="text-4xl font-bold mb-6" style="color: var(--text-primary);">Appointments and Telemedicine</h2>
            <p class="text-gray-400 mb-8">Schedule and manage your virtual and in-person consultations with ease.</p>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Appointment Booking System -->
                <div class="card p-6">
                    <h3 class="text-2xl font-semibold mb-6 flex items-center space-x-2"
                        style="color: var(--text-primary);">
                        <i data-lucide="calendar-plus" class="w-7 h-7 color-accent-text"></i>
                        <span>Book a Consultation</span>
                    </h3>
                    <form onsubmit="bookAppointment(event)">
                        <div class="space-y-4">
                            <div class="input-group">
                                <label for="specialty" class="block text-sm font-medium mb-1">Select Specialty</label>
                                <i data-lucide="user-plus" class="w-5 h-5"></i>
                                <select id="specialty"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-[var(--accent-color)]"
                                    required>
                                    <option value="">-- Choose Specialist --</option>
                                    <option value="general">General Practitioner</option>
                                    <option value="cardio">Cardiologist</option>
                                    <option value="therapy">Therapist/Counselor</option>
                                    <option value="nutritionist">Registered Nutritionist</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="date" class="block text-sm font-medium mb-1">Preferred Date</label>
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                <input type="date" id="date"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-[var(--accent-color)]"
                                    required>
                            </div>
                            <div class="input-group">
                                <label for="type" class="block text-sm font-medium mb-1">Consultation Type</label>
                                <i data-lucide="video" class="w-5 h-5"></i>
                                <select id="type"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-[var(--accent-color)]"
                                    required>
                                    <option value="video">Secure Video (Telemedicine)</option>
                                    <option value="inperson">In-Person Clinic Visit</option>
                                    <option value="phone">Phone Call</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="reason" class="block text-sm font-medium mb-1">Reason for Visit</label>
                                <i data-lucide="stethoscope" class="w-5 h-5"></i>
                                <textarea id="reason" placeholder="Briefly describe your reason for booking..." rows="2"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-[var(--accent-color)]"
                                    required></textarea>
                            </div>
                            <button type="submit"
                                class="w-full color-bg-accent color-bg-accent-hover text-black font-bold py-2.5 rounded-lg transition duration-150 shadow-md transform hover:scale-[1.01]">
                                Find Available Slots
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Patient Portal -->
                <div class="space-y-8">
                    <!-- Secure Patient Portal -->
                    <div class="card p-6">
                        <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="lock" class="w-7 h-7 color-accent-text"></i>
                            <span>Secure Patient Portal</span>
                        </h3>
                        <p class="text-gray-400 mb-4">Safely access your medical history, prescriptions, and reports.
                        </p>
                        <ul class="space-y-3 text-sm">
                            <li class="flex justify-between items-center text-gray-300">
                                <span>Medical History Summary</span>
                                <button onclick="portalAction('view records')"
                                    class="color-accent-text hover:text-teal-400 font-medium transform hover:scale-[1.05]">View</button>
                            </li>
                            <li class="flex justify-between items-center text-gray-300">
                                <span>Recent Prescriptions</span>
                                <button onclick="portalAction('download prescription')"
                                    class="color-accent-text hover:text-teal-400 font-medium transform hover:scale-[1.05]">Download</button>
                            </li>
                            <li class="flex justify-between items-center text-gray-300">
                                <span>Lab Results (Last 6 months)</span>
                                <button onclick="portalAction('view lab results')"
                                    class="color-accent-text hover:text-teal-400 font-medium transform hover:scale-[1.05]">View</button>
                            </li>
                        </ul>
                        <button onclick="portalAction('manage access')"
                            class="mt-6 w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                            Manage Portal Access
                        </button>
                    </div>

                    <!-- Subscription Quick Link -->
                    <div class="card p-6 border-l-4 border-yellow-500">
                        <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="crown" class="w-7 h-7 text-yellow-500"></i>
                            <span>Premium Features</span>
                        </h3>
                        <p class="text-gray-400 mb-6">Unlock advanced features like priority booking, detailed reports,
                            and AI assistance.</p>
                        <button onclick="showView('subscription')"
                            class="w-full bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2.5 rounded-lg transition duration-150 shadow-md transform hover:scale-[1.01]">
                            View Plans & Upgrade
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools View -->
        <div id="tools-view" class="view">
            <h2 class="text-4xl font-bold mb-6" style="color: var(--text-primary);">Health Tools and Smart Empowerment
            </h2>
            <p class="text-gray-400 mb-8">Access our personalized planners and AI assistants to manage your daily life.
            </p>

            <h3 class="text-2xl font-bold mb-4 flex items-center space-x-2" style="color: var(--text-primary);">
                <i data-lucide="sliders" class="w-6 h-6 color-accent-text"></i>
                <span>Health Management & Analytics</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

                <!-- 1. Health Reports Generator -->
                <div class="card p-6 flex flex-col items-center text-center tool-card">
                    <i data-lucide="file-text" class="w-12 h-12 color-accent-text mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">Health Reports Generator
                    </h3>
                    <p class="text-gray-400 mb-4 text-sm flex-grow">Generate and export detailed weekly and monthly
                        health summaries for easy sharing.</p>
                    <button onclick="generateHealthReport()"
                        class="w-full color-bg-accent color-bg-accent-hover text-black py-2 rounded-lg font-bold transition duration-150 mt-4 transform hover:scale-[1.01]">
                        Generate Report
                    </button>
                </div>

                <!-- 2. Genomic Health Insights -->
                <div class="card p-6 flex flex-col items-center text-center tool-card">
                    <i data-lucide="dna" class="w-12 h-12 text-green-500 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">Genomic Health Insights
                    </h3>
                    <p class="text-gray-400 mb-4 text-sm flex-grow">Access personalized medicine recommendations and
                        genetic risk reports.</p>
                    <button onclick="showGenomicInsightsModal()"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 mt-4 transform hover:scale-[1.01]">
                        View Insights
                    </button>
                </div>

                <!-- 3. Medication Management -->
                <div class="card p-6 flex flex-col items-center text-center tool-card">
                    <i data-lucide="pill" class="w-12 h-12 text-orange-400 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">Medication Management
                    </h3>
                    <p class="text-gray-400 mb-4 text-sm flex-grow">Set smart reminders and track your adherence for all
                        prescriptions.</p>
                    <button onclick="showMedicationAdherenceModal()"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 mt-4 transform hover:scale-[1.01]">
                        Manage Medications
                    </button>
                </div>
            </div>

            <h3 class="text-2xl font-bold mb-4 flex items-center space-x-2" style="color: var(--text-primary);">
                <i data-lucide="target" class="w-6 h-6 color-accent-text"></i>
                <span>Personal Planners & Routines</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Nutrition Planner -->
                <div class="card p-6 flex flex-col items-center text-center tool-card">
                    <i data-lucide="apple" class="w-12 h-12 color-accent-text mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">Nutrition Planner</h3>
                    <p class="text-gray-400 mb-4 text-sm flex-grow">Get personalized diet plans, track macros, and meet
                        your wellness goals.</p>
                    <button onclick="openPlanner('Nutrition')"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 mt-4 transform hover:scale-[1.01]">
                        View Planner
                    </button>
                </div>

                <!-- Workout Planner -->
                <div class="card p-6 flex flex-col items-center text-center tool-card">
                    <i data-lucide="activity" class="w-12 h-12 color-accent-text mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">Workout Planner</h3>
                    <p class="text-gray-400 mb-4 text-sm flex-grow">Access custom exercise routines based on your
                        fitness level and equipment.</p>
                    <button onclick="openPlanner('Workout')"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 mt-4 transform hover:scale-[1.01]">
                        View Planner
                    </button>
                </div>

                <!-- Wellness Planner -->
                <div class="card p-6 flex flex-col items-center text-center tool-card">
                    <i data-lucide="dumbbell" class="w-12 h-12 text-pink-400 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">Yoga & Mindfulness</h3>
                    <p class="text-gray-400 mb-4 text-sm flex-grow">Find routines, track sessions, and monitor
                        mindfulness scores.</p>
                    <button onclick="showView('wellness')"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 mt-4 transform hover:scale-[1.01]">
                        Go to Wellness Studio
                    </button>
                </div>

                <!-- Symptom Checker -->
                <div class="card p-6 flex flex-col items-center text-center tool-card">
                    <i data-lucide="stethoscope" class="w-12 h-12 color-accent-text mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">AI Symptom Checker</h3>
                    <p class="text-gray-400 mb-4 text-sm flex-grow">Receive preliminary, non-diagnostic guidance based
                        on your current symptoms.</p>
                    <button onclick="showSymptomCheckerModal()"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 mt-4 transform hover:scale-[1.01]">
                        Start Check
                    </button>
                </div>

                <!-- Content Library -->
                <div class="card p-6 flex flex-col items-center text-center tool-card">
                    <i data-lucide="book-open" class="w-12 h-12 color-accent-text mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">Content Library</h3>
                    <p class="text-gray-400 mb-4 text-sm flex-grow">Articles, videos, and tips on health, fitness, and
                        nutrition verified by experts.</p>
                    <button onclick="openPlanner('Content Library')"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 mt-4 transform hover:scale-[1.01]">
                        Browse Insights
                    </button>
                </div>
            </div>
        </div>

        <!-- Environmental View -->
        <div id="environmental-view" class="view">
            <button onclick="showView('dashboard')"
                class="mb-6 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition duration-150 flex items-center space-x-2 transform hover:scale-[1.03]">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span>Back to Dashboard</span>
            </button>
            <h2 class="text-4xl font-bold mb-6 flex items-center" style="color: var(--text-primary);">
                <i data-lucide="cloud-fog" class="w-9 h-9 mr-3 text-indigo-400"></i>
                Environmental Health Control
            </h2>
            <p class="text-gray-400 mb-8">Real-time data and alerts regarding local air, water, and climate conditions
                that affect your health.</p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Main Environmental Metrics (2/3 width) -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="card p-6 border-l-4 border-indigo-400">
                        <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="wind" class="w-6 h-6 text-indigo-400"></i>
                            <span>Current Conditions & Alerts</span>
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="score-item rounded-lg">
                                <p class="text-3xl font-extrabold text-yellow-400">125</p>
                                <p class="text-sm text-gray-400">AQI (Moderate)</p>
                            </div>
                            <div class="score-item rounded-lg">
                                <p class="text-3xl font-extrabold text-red-400">High</p>
                                <p class="text-sm text-gray-400">Pollen Count</p>
                            </div>
                            <div class="score-item rounded-lg">
                                <p class="text-3xl font-extrabold text-green-400">3</p>
                                <p class="text-sm text-gray-400">UV Index (Low)</p>
                            </div>
                            <div class="score-item rounded-lg">
                                <p class="text-3xl font-extrabold text-blue-400">22°C</p>
                                <p class="text-sm text-gray-400">Current Temp</p>
                            </div>
                        </div>

                        <div class="mt-6">
                            <h4 class="text-lg font-semibold" style="color: var(--text-primary);">Health
                                Recommendations:</h4>
                            <p class="text-sm text-yellow-400">Air quality is Moderate. Sensitive groups
                                (asthma/allergies) should reduce outdoor exertion and wear a mask.</p>
                        </div>
                    </div>

                    <!-- Air Pollution Forecast -->
                    <div class="card p-6">
                        <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="line-chart" class="w-6 h-6 text-yellow-500"></i>
                            <span>48-Hour Air Pollution Forecast</span>
                        </h3>
                        <div class="grid grid-cols-3 gap-4 text-center text-sm">
                            <div class="score-item p-3 rounded-lg">
                                <p class="font-bold" style="color: var(--text-primary);">Tomorrow AM</p>
                                <p class="text-green-400">Good (AQI 45)</p>
                            </div>
                            <div class="score-item p-3 rounded-lg">
                                <p class="font-bold" style="color: var(--text-primary);">Tomorrow PM</p>
                                <p class="text-yellow-400">Moderate (AQI 98)</p>
                            </div>
                            <div class="score-item p-3 rounded-lg">
                                <p class="font-bold" style="color: var(--text-primary);">Day After</p>
                                <p class="text-red-400">Unhealthy (AQI 155)</p>
                            </div>
                        </div>
                        <button
                            onclick="showModal('Forecast Alert', 'Setting up personalized alerts for when the Air Quality Index is forecast to exceed 100.','Set Alert')"
                            class="mt-4 w-full text-sm font-bold text-yellow-500 hover:text-yellow-400 transition duration-150">
                            Configure AQI Alerts
                        </button>
                    </div>
                </div>

                <!-- Water Quality & Actions (1/3 width) -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="droplets" class="w-6 h-6 text-blue-400"></i>
                            <span>Water Quality Status</span>
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">Water quality in your area is currently **safe** based on
                            municipal data.</p>
                        <ul class="space-y-3 text-sm mb-4">
                            <li class="flex justify-between items-center text-gray-300">
                                <span>Last Tested:</span>
                                <span class="font-bold text-green-400">2 hours ago</span>
                            </li>
                            <li class="flex justify-between items-center text-gray-300">
                                <span>pH Level:</span>
                                <span class="font-bold" style="color: var(--text-primary);">7.2 (Neutral)</span>
                            </li>
                        </ul>
                        <button onclick="showWaterQualityModal()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                            Set Water Quality Reminders
                        </button>
                    </div>

                    <!-- Hyper-local Water Testing -->
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="flask-conical" class="w-6 h-6 text-blue-400"></i>
                            <span>Hyper-local Testing</span>
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">Request a kit to test your tap water directly for lead,
                            chlorine, and minerals.</p>
                        <button
                            onclick="showModal('Water Test Kit', 'Simulating ordering a home water test kit. Results will be uploaded directly to your PULSE profile.','Order Kit')"
                            class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                            Request Test Kit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Planner View -->
        <div id="planner-view" class="view">
            <button onclick="showView('tools')"
                class="mb-6 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition duration-150 flex items-center space-x-2 transform hover:scale-[1.03]">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span>Back to Tools</span>
            </button>
            <h2 id="planner-title" class="text-4xl font-bold color-accent-text mb-6 flex items-center">Health Planner
            </h2>
            <p class="text-gray-400 mb-8">Set your goals and track your progress in this personalized tool.</p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Planner Overview -->
                <div class="lg:col-span-2 space-y-6">

                    <!-- AI Tools Card - Dynamic Content based on planner type -->
                    <div id="ai-planner-tools-card" class="card p-6 border-l-4 border-yellow-400">
                        <!-- Content dynamically injected by JS -->
                    </div>


                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="check-square" class="w-6 h-6 color-accent-text"></i>
                            <span>Today's Task List</span>
                        </h3>
                        <ul id="planner-tasks" class="space-y-3 text-sm">
                            <!-- Tasks populated by JS -->
                        </ul>
                        <button id="add-task-button" onclick="showPlannerLogModal('Nutrition')"
                            class="mt-4 text-sm font-bold color-accent-text hover:text-teal-400 transform hover:scale-[1.05]">
                            Add New Task/Entry
                        </button>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="trending-up" class="w-6 h-6 color-accent-text"></i>
                            <span>Long-Term Progress</span>
                        </h3>
                        <!-- CHART.JS IMPLEMENTATION FOR PLANNER -->
                        <div style="height: 280px;">
                            <canvas id="longTermChart"></canvas>
                        </div>
                        <!-- END CHART.JS IMPLEMENTATION -->
                    </div>
                </div>

                <!-- Planner Side Panel -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="user-cog" class="w-6 h-6 color-accent-text"></i>
                            <span>My Profile & Goals</span>
                        </h3>
                        <p class="text-sm text-gray-400">Adjust calorie targets, preferred workout days, or dietary
                            restrictions.</p>
                        <button
                            onclick="showModal('Profile Settings', 'Opening profile settings specific to this planner.', 'Edit Settings')"
                            class="mt-4 w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                            Edit Planner Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- WELLNESS View -->
        <div id="wellness-view" class="view">
            <button onclick="showView('tools')"
                class="mb-6 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition duration-150 flex items-center space-x-2 transform hover:scale-[1.03]">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span>Back to Tools</span>
            </button>
            <h2 class="text-4xl font-bold mb-6 flex items-center" style="color: var(--text-primary);">
                <i data-lucide="dumbbell" class="w-9 h-9 mr-3 text-pink-400"></i>
                Yoga & Mindfulness Studio
            </h2>
            <p class="text-gray-400 mb-8">Select a guided session, log your mindfulness practice, or generate a custom
                routine.</p>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Personalized Session Generator -->
                <div class="lg:col-span-3 card p-6 border-l-4 border-yellow-400 mb-6">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                        style="color: var(--text-primary);">
                        <i data-lucide="wand-2" class="w-6 h-6 text-yellow-400"></i>
                        <span>AI Personalized Session Generator</span>
                    </h3>
                    <p class="text-sm text-gray-400 mb-4">Generate a 15-minute yoga flow targeting hip flexibility and
                        stress reduction based on your last dashboard metrics.</p>
                    <button onclick="generateCustomSession()"
                        class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 rounded-lg transition duration-150 transform hover:scale-[1.01] flex items-center justify-center space-x-2">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                        <span>Generate Custom Flow Now</span>
                    </button>
                </div>

                <!-- Meditation/Mindfulness Section -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-6 border-l-4 border-pink-400">
                        <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="headphones" class="w-6 h-6 text-pink-400"></i>
                            <span>Meditation Sessions</span>
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">Track your sessions and improve focus with audio guides.
                        </p>

                        <div class="space-y-3">
                            <div class="score-item p-3 rounded-lg flex justify-between items-center">
                                <span class="font-medium" style="color: var(--text-primary);">Deep Sleep (10 min)</span>
                                <button onclick="startSession('Deep Sleep Meditation')"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-full text-sm font-semibold">Start</button>
                            </div>
                            <div class="score-item p-3 rounded-lg flex justify-between items-center">
                                <span class="font-medium" style="color: var(--text-primary);">Focus Boost (5 min)</span>
                                <button onclick="startSession('Focus Boost Meditation')"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-full text-sm font-semibold">Start</button>
                            </div>
                        </div>

                        <button onclick="logMeditation()"
                            class="w-full bg-pink-600 hover:bg-pink-700 text-white py-2 rounded-lg transition duration-150 transform hover:scale-[1.01] mt-4 flex items-center justify-center space-x-2">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            <span>Log New Session</span>
                        </button>
                    </div>
                </div>

                <!-- Yoga Section (2/3 width) -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="card p-6 border-l-4 border-teal-400">
                        <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2"
                            style="color: var(--text-primary);">
                            <i data-lucide="hand" class="w-6 h-6 color-accent-text"></i>
                            <span>Yoga Routines</span>
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">Access guided yoga flows based on your goals (Strength,
                            Flexibility, De-stress).</p>
                        <ul class="space-y-4">
                            <li
                                class="bg-gray-700/30 p-4 rounded-lg flex justify-between items-center hover:bg-gray-700 transition duration-150">
                                <div>
                                    <p class="font-bold" style="color: var(--text-primary);">Morning Flow (20 min)</p>
                                    <p class="text-sm text-gray-400">Goal: Energy & Alignment</p>
                                </div>
                                <button onclick="startSession('Morning Yoga Flow')"
                                    class="color-bg-accent color-bg-accent-hover text-black px-4 py-1.5 rounded-full text-sm font-semibold">Start</button>
                            </li>
                            <li
                                class="bg-gray-700/30 p-4 rounded-lg flex justify-between items-center hover:bg-gray-700 transition duration-150">
                                <div>
                                    <p class="font-bold" style="color: var(--text-primary);">Office Break Stretch (5
                                        min)</p>
                                    <p class="text-sm text-gray-400">Goal: Shoulder & Neck Relief</p>
                                </div>
                                <button onclick="startSession('Office Break Stretch')"
                                    class="color-bg-accent color-bg-accent-hover text-black px-4 py-1.5 rounded-full text-sm font-semibold">Start</button>
                            </li>
                            <li
                                class="bg-gray-700/30 p-4 rounded-lg flex justify-between items-center hover:bg-gray-700 transition duration-150">
                                <div>
                                    <p class="font-bold" style="color: var(--text-primary);">Hip Opener & Flexibility
                                        (30 min)</p>
                                    <p class="text-sm text-gray-400">Goal: Deep Flexibility</p>
                                </div>
                                <button onclick="startSession('Hip Opener')"
                                    class="color-bg-accent color-bg-accent-hover text-black px-4 py-1.5 rounded-full text-sm font-semibold">Start</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>


        <!-- Connect View -->
        <div id="connect-view" class="view">
            <h2 class="text-4xl font-bold mb-6" style="color: var(--text-primary);">Connect & Support</h2>
            <p class="text-gray-400 mb-8">Get instant answers and secure access to our support teams.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- 1. Smartwatch/Fitness Band Link -->
                <div
                    class="card p-6 bg-gray-700/30 border border-gray-600 hover:shadow-lg hover:border-green-400 transition duration-300">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                        style="color: var(--text-primary);">
                        <i data-lucide="watch" class="w-7 h-7 text-green-400"></i>
                        <span>Device Link Hub</span>
                    </h3>
                    <p class="text-gray-400 mb-4">Manage linked devices, check sync status, import data, and set
                        permissions.</p>
                    <button onclick="showDeviceLinkModal()"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
                        <i data-lucide="link" class="w-5 h-5"></i>
                        <span>Go to Device Hub</span>
                    </button>
                </div>

                <!-- 2. Specialist Consultation Finder -->
                <div
                    class="card p-6 bg-indigo-900/20 border border-indigo-700 hover:shadow-lg hover:border-indigo-400 transition duration-300">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                        style="color: var(--text-primary);">
                        <i data-lucide="stethoscope" class="w-7 h-7 text-indigo-400"></i>
                        <span>Find Specialist</span>
                    </h3>
                    <p class="text-gray-400 mb-4">Quickly book virtual consultations with doctors and mental health
                        professionals for specific concerns.</p>
                    <button onclick="showSpecialistFinderModal()"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
                        <i data-lucide="user-search" class="w-5 h-5"></i>
                        <span>Connect to a Specialist</span>
                    </button>
                </div>

                <!-- 3. AI Chatbot/Live Chat -->
                <div
                    class="card p-6 bg-indigo-900/20 border border-indigo-700 hover:shadow-lg hover:border-accent-teal transition duration-300">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                        style="color: var(--text-primary);">
                        <i data-lucide="message-square" class="w-7 h-7 color-accent-text"></i>
                        <span>AI Assistant Chat</span>
                    </h3>
                    <p class="text-gray-400 mb-4">Start an instant conversation with PULSE AI for data summaries and
                        technical help.</p>
                    <button onclick="showView('chatbot')"
                        class="w-full color-bg-accent color-bg-accent-hover text-black font-bold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
                        <i data-lucide="message-square-text" class="w-5 h-5"></i>
                        <span>Start AI Chat Now</span>
                    </button>
                </div>

                <!-- 4. Secure Direct Contact -->
                <div
                    class="card p-6 bg-gray-700/30 border border-gray-600 hover:shadow-lg hover:border-accent-teal transition duration-300">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2"
                        style="color: var(--text-primary);">
                        <i data-lucide="mail" class="w-7 h-7 color-accent-text"></i>
                        <span>Secure Direct Contact</span>
                    </h3>
                    <p class="text-gray-400 mb-4">Send a secure message to our support team for complex or confidential
                        inquiries.</p>
                    <button onclick="sendSecureMessage()"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition duration-150 flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
                        <i data-lucide="mail-open" class="w-5 h-5"></i>
                        <span>Send Secure Message</span>
                    </button>
                </div>

                <!-- 5. Community Forum / Peer Support -->
                <div
                    class="card p-6 md:col-span-2 lg:col-span-1 bg-purple-900/20 border border-purple-700 hover:shadow-lg hover:border-purple-400 transition duration-300">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2 text-purple-400"
                        style="color: var(--text-primary);">
                        <i data-lucide="users" class="w-7 h-7"></i>
                        <span>Peer Support & Forums</span>
                    </h3>
                    <p class="text-gray-400 mb-4">Connect with other users, find supportive groups, and discuss health
                        challenges confidentially.</p>
                    <button onclick="showCommunityPortalModal()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
                        <i data-lucide="users-round" class="w-5 h-5"></i>
                        <span>Access Forum & Groups</span>
                    </button>
                </div>

                <!-- 6. Mental Health Intervention -->
                <div
                    class="card p-6 md:col-span-2 border-l-4 border-red-500 bg-red-900/20 lg:col-span-3 hover:shadow-xl transition duration-300">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center space-x-2 text-red-400"
                        style="color: var(--text-primary);">
                        <i data-lucide="shield-alert" class="w-7 h-7"></i>
                        <span>Mental Health Crisis Support</span>
                    </h3>
                    <p class="text-gray-400 mb-4">If you are feeling overwhelmed or require immediate mental health
                        assistance, use the button below.</p>
                    <button onclick="showMentalHealthCrisisModal()"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center space-x-2 transform hover:scale-[1.01]">
                        <i data-lucide="user-x" class="w-5 h-5"></i>
                        <span>Access Crisis Intervention</span>
                    </button>
                </div>
            </div>
        </div>
    </main>
    <!-- Chatbot Fixed Icon -->
    <div class="chatbot-fixed">
        <a href="/chatbot">
            <button onclick="showView('chatbot')"
                class="bg-indigo-600 hover:bg-indigo-700 p-4 rounded-full transition duration-300 shadow-xl transform hover:scale-110"
                title="Open AI Chatbot" aria-label="Open AI Chatbot">
                <i data-lucide="message-square-text" class="w-6 h-6 text-white"></i>
            </button>
        </a>
    </div>

    <!-- Footer -->
    <footer class="header-bg mt-12 py-10 border-t" style="border-color: var(--input-border);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-sm text-gray-500">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div>
                    <h4 class="text-base font-semibold mb-3" style="color: var(--text-primary);">PULSE</h4>
                    <p>© 2025 PULSE Health Tech. All rights reserved.</p>
                </div>
                <div>
                    <h4 class="text-base font-semibold mb-3" style="color: var(--text-primary);">Platform</h4>
                    <ul class="space-y-2">
                        <li><a href="#" onclick="showView('dashboard')"
                                class="hover:color-accent-text transition duration-150">Dashboard</a></li>
                        <li><a href="#" onclick="showView('tools')"
                                class="hover:color-accent-text transition duration-150">Tools & Planners</a></li>
                        <li><a href="#" onclick="showView('booking')"
                                class="hover:color-accent-text transition duration-150">Appointments</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-base font-semibold mb-3" style="color: var(--text-primary);">Legal & Trust</h4>
                    <ul class="space-y-2">
                        <li><button onclick="showCompliance('HIPAA')"
                                class="hover:color-accent-text transition duration-150">HIPAA Compliance</button></li>
                        <li><button onclick="showCompliance('GDPR')"
                                class="hover:color-accent-text transition duration-150">GDPR Data Privacy</button></li>
                        <li><button onclick="showCompliance('WCAG')"
                                class="hover:color-accent-text transition duration-150">Accessibility (WCAG)</button>
                        </li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-base font-semibold mb-3" style="color: var(--text-primary);">Contact</h4>
                    <ul class="space-y-2">
                        <li><button onclick="sendSecureMessage()"
                                class="hover:color-accent-text transition duration-150">Secure Messaging</button></li>
                        <li><button onclick="showMentalHealthCrisisModal()"
                                class="text-red-500 hover:text-red-400 transition duration-150">Crisis Support</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- Universal Modal Backdrop for Messages/Forms -->
    <div id="universal-modal-backdrop" class="modal-backdrop">
        <div id="universal-modal-content" class="modal-content">
            <!-- Content injected by JS -->
        </div>
    </div>

    <!-- Authentication Modal Backdrop (Login/Signup) -->
    <div id="auth-modal-backdrop" class="modal-backdrop">
        <div id="auth-modal-content" class="modal-content">
            <button onclick="hideAuthModal()" class="float-right text-gray-400 hover:text-white text-3xl leading-none"
                aria-label="Close authentication modal">&times;</button>
            <h3 id="auth-title" class="text-2xl font-bold mb-4" style="color: var(--text-primary);">Login</h3>

            <!-- Login Form -->
            <form id="login-form" onsubmit="loginUser(event)" class="space-y-4">
                <div class="input-group">
                    <i data-lucide="mail" class="w-5 h-5"></i>
                    <input type="email" id="login-email" placeholder="Email" required
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-[var(--accent-color)]">
                </div>
                <div class="input-group">
                    <i data-lucide="lock" class="w-5 h-5"></i>
                    <input type="password" id="login-password" placeholder="Password" required
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-[var(--accent-color)]">
                </div>
                <button type="submit"
                    class="w-full color-bg-accent color-bg-accent-hover text-black font-bold py-2.5 rounded-lg">
                    Login
                </button>
            </form>

            <!-- Sign Up Form -->
            <form id="signup-form" onsubmit="signUpUser(event)" class="space-y-4 hidden">
                <div class="input-group">
                    <i data-lucide="mail" class="w-5 h-5"></i>
                    <input type="email" id="signup-email" placeholder="Email" required
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-[var(--accent-color)]">
                </div>
                <div class="input-group">
                    <i data-lucide="lock" class="w-5 h-5"></i>
                    <input type="password" id="signup-password" placeholder="Password (min 8 chars)" required
                        minlength="8"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-[var(--accent-color)]">
                </div>
                <button type="submit"
                    class="w-full color-bg-accent color-bg-accent-hover text-black font-bold py-2.5 rounded-lg">
                    Create Account
                </button>
            </form>

            <p class="mt-4 text-center text-sm">
                <span class="text-gray-400">
                    <a href="#" onclick="switchAuthMode(event, 'signup')" id="switch-to-signup"
                        class="color-accent-text hover:text-teal-400 font-medium">Create an Account</a>
                    <a href="#" onclick="switchAuthMode(event, 'login')" id="switch-to-login"
                        class="color-accent-text hover:text-teal-400 font-medium hidden">Back to Login</a>
                </span>
            </p>
        </div>
    </div>

    <!-- Load Custom Scripts -->
    <script>
        // =======================================================
        // 1. GLOBAL STATE & DATA DECLARATIONS
        // =======================================================

        // FIXED: Removed server-side middleware function from client code
        let isLoggedIn = false; // Changed from function to proper state variable
        let loggedInUser = '';
        let plannerChartInstance = null;
        let dashboardChartInstance = null;
        let currentTheme = 'dark';

        const mockGoals = [
            { id: 1, name: "Daily Steps (10,000)", target: 10000, current: 7500, type: "Activity" },
            { id: 2, name: "Sleep Avg (8 hours)", target: 8, current: 8.25, type: "Sleep" },
            { id: 3, name: "Strength Training (3x/wk)", target: 3, current: 2, type: "Workout" },
        ];
        let nextGoalId = 4;

        let mockActivities = [
            { id: 1, metric: "STEPS", value: 15000, date: new Date().toLocaleDateString(), type: "Activity" },
            { id: 2, metric: "SLEEP", value: "8 hours", date: new Date(Date.now() - 86400000).toLocaleDateString(), type: "Sleep" },
            { id: 3, metric: "BP", value: "130/85", date: new Date(Date.now() - 2 * 86400000).toLocaleDateString(), type: "Health" },
        ];
        let nextActivityId = 4;

        let mockMedications = [
            { id: 101, name: "Metformin (500mg)", schedule: "8:00 AM Daily", status: "Active", adherence: 88, nextDose: "8:00 AM", dosage: "500mg", frequency: "Daily" },
            { id: 102, name: "Vitamin D (1000 IU)", schedule: "1:00 PM Daily", status: "Active", adherence: 95, nextDose: "1:00 PM", dosage: "1000 IU", frequency: "Daily" },
            { id: 103, name: "Aspirin (81mg)", schedule: "6:00 PM Daily", status: "Active", adherence: 75, nextDose: "6:00 PM", dosage: "81mg", frequency: "Daily" },
            { id: 104, name: "Amoxicillin", schedule: "2x/Day for 7 days", status: "Completed", adherence: 100, nextDose: "-", dosage: "250mg", frequency: "Twice Daily" },
        ];
        let nextMedicationId = 105;

        let hasNewActivity = false;

        let healthScores = {
            activity: 92,
            sleep: 85,
            stress: 79,
            nutrition: 95
        };

        const NUTRITION_TASKS = [
            { name: 'Log Dinner (Target: 600 kcal)', completed: false, icon: 'apple' },
            { name: 'Drink 8 glasses of water', completed: true, icon: 'droplet' },
            { name: 'Review Macro Breakdown', completed: false, icon: 'utensils' },
            { name: 'Take multivitamin', completed: true, icon: 'milk' }
        ];

        const WORKOUT_TASKS = [
            { name: 'Complete Leg Day Routine', completed: false, icon: 'run' },
            { name: 'Log 1 hour yoga session', completed: true, icon: 'dumbbell' },
            { name: 'Set recovery day reminder', completed: false, icon: 'stretching' },
            { name: 'Check heart rate zones', completed: false, icon: 'heart-pulse' }
        ];

        // FIXED: Added placeholder for API key with clear instructions
        const apiKey = "YOUR_GEMINI_API_KEY_HERE"; // Replace with actual API key
        const geminiUrl = (model) => `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        let isListening = false;
        let recognition = null;
        let base64ImageFile = null;

        // =======================================================
        // 2. AUTH STATUS CHECK (FIXED)
        // =======================================================

        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const savedUser = localStorage.getItem('user');

            // If no token at all → definitely not logged in
            if (!token) {
                setLoggedIn(false);
                return;
            }

            // If we have token + saved user → auto-login (offline mode safe)
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    const username = userData.name || userData.email?.split('@')[0] || 'User';
                    setLoggedIn(true, username);
                    console.log('Auto-logged in from localStorage:', username);
                    return; // Success → exit early
                } catch (e) {
                    console.warn('Failed to parse saved user data');
                }
            }

            // Only try server verification if online + backend exists
            if (navigator.onLine) {
                try {
                    const response = await fetch('/auth/verify', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        const username = userData.name || userData.email?.split('@')[0] || 'User';
                        localStorage.setItem('user', JSON.stringify(userData)); // Update saved user
                        setLoggedIn(true, username);
                        return;
                    }
                } catch (error) {
                    console.warn('Server unreachable or verify failed (normal in offline mode):', error.message);
                    // Don't logout just because server is down!
                }
            }

            // Final fallback: if we have a token, assume logged in (offline-friendly)
            if (token) {
                const fallbackName = token.substring(0, 8) + '...'; // or decode JWT if needed
                setLoggedIn(true, 'User');
                console.log('Logged in via token only (offline mode)');
            } else {
                setLoggedIn(false);
            }
        }

        // =======================================================
        // 3. GLOBALLY ACCESSED FUNCTIONS
        // =======================================================

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        function showAuthModal(mode = 'login') {
            const authModal = document.getElementById('auth-modal-backdrop');
            if (authModal) {
                authModal.style.display = 'flex';
                switchAuthMode(null, mode);
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        }

        function hideAuthModal() {
            const authModal = document.getElementById('auth-modal-backdrop');
            if (authModal) {
                authModal.style.display = 'none';
            }
        }

        function switchAuthMode(event, mode) {
            if (event) event.preventDefault();
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const title = document.getElementById('auth-title');
            const switchToSignupLink = document.getElementById('switch-to-signup');
            const switchToLoginLink = document.getElementById('switch-to-login');

            if (mode === 'login') {
                loginForm?.classList.remove('hidden');
                signupForm?.classList.add('hidden');
                if (title) title.textContent = 'Login to PULSE';
                switchToSignupLink?.classList.remove('hidden');
                switchToLoginLink?.classList.add('hidden');
            } else {
                loginForm?.classList.add('hidden');
                signupForm?.classList.remove('hidden');
                if (title) title.textContent = 'Create PULSE Account';
                switchToSignupLink?.classList.add('hidden');
                switchToLoginLink?.classList.remove('hidden');
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function signOutUser() {
            try {
                await fetch('/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (err) {
                console.warn('Logout request failed (offline OK)', err);
            } finally {
                localStorage.removeItem('token');
                localStorage.removeItem('user');  // ← Add this line!
                setLoggedIn(false);
                showModal('Signed Out', 'You have been securely logged out.', 'Login Again');
                showView('home');
            }
        }

        function showMentalHealthCrisisModal() {
            const content = `
        <button onclick="hideModal()" class="float-right text-gray-400 hover:text-white text-3xl leading-none" aria-label="Close crisis intervention modal">&times;</button>
        <h3 class="text-2xl font-bold mb-4 text-red-400 flex items-center space-x-2"><i data-lucide="alert-triangle" class="w-7 h-7"></i><span>Immediate Crisis Intervention</span></h3>
        <p class="text-white mb-4" style="color: var(--text-primary);">If you are facing an emergency or feeling unsafe, please choose the option below that best supports you right now. **We are here to listen.**</p>
        <div class="space-y-4">
            <button onclick="crisisAction('Emergency Services')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-150 flex items-center justify-center space-x-2">
                <i data-lucide="phone" class="w-5 h-5"></i><span>Call Emergency Services (108/102)</span>
            </button>
            <button onclick="crisisAction('National Helpline')" class="w-full bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-3 rounded-lg transition duration-150 flex items-center justify-center space-x-2">
                <i data-lucide="message-square" class="w-5 h-5"></i><span>Connect to National Helpline (Chat/Call)</span>
            </button>
            <button onclick="crisisAction('Emergency Contact')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 flex items-center justify-center space-x-2">
                <i data-lucide="user-plus" class="w-5 h-5"></i><span>Alert Emergency Contact</span>
            </button>
        </div>
        <div class="mt-6 p-4 rounded-lg bg-gray-800 border" style="border-color: var(--input-border);">
            <h4 class="text-base font-semibold mb-2" style="color: var(--text-primary);">Feeling Overwhelmed?</h4>
            <p class="text-xs text-gray-400">If you are not in immediate danger, consider using the <button onclick="hideModal(); showView('wellness')" class="text-pink-400 underline">Wellness Studio</button> or talking to our <button onclick="hideModal(); showView('chatbot')" class="color-accent-text underline">AI Assistant</button> for immediate de-stressing techniques.</p>
        </div>
        <p class="text-gray-500 text-xs mt-4 text-center">Your privacy is paramount. This information is used solely for intervention purposes.</p>
    `;
            const modalContent = document.getElementById('universal-modal-content');
            if (modalContent) {
                modalContent.innerHTML = content;
                modalContent.classList.remove('modal-lg');
                document.getElementById('universal-modal-backdrop').style.display = 'flex';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        }

        // =======================================================
        // 4. UTILITY FUNCTIONS
        // =======================================================

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response.json();
                    }
                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function updateHeaderAuthDisplay() {
            const authButtons = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');
            const userGreeting = document.getElementById('user-greeting');
            const homeTeaser = document.getElementById('home-wellness-teaser');

            if (isLoggedIn) {
                authButtons?.classList.add('hidden');
                userInfo?.classList.remove('hidden');
                userInfo?.classList.add('flex');
                if (userGreeting) userGreeting.textContent = `Hey, ${loggedInUser}!`;
                if (homeTeaser) homeTeaser.style.display = 'inline-block';
            } else {
                authButtons?.classList.remove('hidden');
                userInfo?.classList.add('hidden');
                userInfo?.classList.remove('flex');
                if (homeTeaser) homeTeaser.style.display = 'none';
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function applyAccentColor(colorName) {
            let color, hover;
            switch (colorName) {
                case 'Teal':
                    color = '#2dd4bf';
                    hover = '#14b8a6';
                    break;
                case 'Indigo':
                    color = '#818cf8';
                    hover = '#6366f1';
                    break;
                case 'Pink':
                    color = '#f472b6';
                    hover = '#ec4899';
                    break;
                default:
                    color = '#2dd4bf';
                    hover = '#14b8a6';
            }

            document.documentElement.style.setProperty('--accent-color', color);
            document.documentElement.style.setProperty('--accent-color-hover', hover);
            document.documentElement.style.setProperty('--accent-text', color);

            if (dashboardChartInstance) renderDashboardChart();
            if (plannerChartInstance) {
                const plannerTitle = document.getElementById('planner-title');
                if (plannerTitle) {
                    renderPlannerChart(plannerTitle.textContent.includes('Nutrition') ? 'Nutrition' : 'Workout');
                }
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            currentTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);

            if (dashboardChartInstance) renderDashboardChart();
            if (plannerChartInstance) {
                const plannerTitle = document.getElementById('planner-title');
                if (plannerTitle) {
                    renderPlannerChart(plannerTitle.textContent.includes('Nutrition') ? 'Nutrition' : 'Workout');
                }
            }

            hideModal();
            showModal('Theme Switched', `Theme changed to **${currentTheme.toUpperCase()}** mode.`, 'OK');
        }

        // =======================================================
        // 5. WINDOW ONLOAD (FIXED)
        // =======================================================

        window.onload = async () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            currentTheme = savedTheme;

            // Critical: Check login status FIRST
            await checkAuthStatus();

            // Update header (shows user name / login buttons)
            updateHeaderAuthDisplay();

            // Apply accent color
            applyAccentColor('Teal');

            if (typeof lucide !== 'undefined') lucide.createIcons();
            updateHeaderAuthDisplay();
            applyAccentColor('Teal');

            // Speech recognition setup
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    const micButton = document.getElementById('mic-button');
                    if (micButton) micButton.classList.add('mic-active');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    sendChat(null, transcript);
                };

                recognition.onend = () => {
                    isListening = false;
                    const micButton = document.getElementById('mic-button');
                    if (micButton) micButton.classList.remove('mic-active');
                };

                checkAuthAndShowDashboard();
                recognition.onerror = (event) => {
                    isListening = false;
                    const micButton = document.getElementById('mic-button');
                    if (micButton) micButton.classList.remove('mic-active');
                    console.error('Speech recognition error:', event.error);
                };
            }
        };

        function toggleVoiceInput() {
            if (!recognition) {
                showModal('Voice Unavailable', 'Your browser does not support the Web Speech API required for voice chat.', 'OK');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (e) {
                    isListening = false;
                    const micButton = document.getElementById('mic-button');
                    if (micButton) micButton.classList.remove('mic-active');
                    showModal('Mic In Use', 'The microphone is already in use or access was denied. Please check permissions.', 'OK');
                }
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files?.[0];
            if (file) {
                fileToBase64(file).then(base64Data => {
                    base64ImageFile = base64Data;
                    event.target.value = '';
                    showModal(
                        'Image Ready for AI',
                        'Image uploaded successfully! Please type your question or request (e.g., "Analyze this meal for calorie estimate" or "What is this plant?") and hit send. The image will be included with your text.',
                        'Got It'
                    );
                }).catch(error => {
                    console.error("Image processing error:", error);
                    showModal('Upload Failed', 'Could not process the image file. Please try again.', 'OK');
                });
            }
        }

        // =======================================================
        // 6. DASHBOARD & SCORING FUNCTIONS
        // =======================================================

        function calculateAndRenderScores() {
            const totalSteps = mockActivities
                .filter(a => a.metric === 'STEPS')
                .reduce((sum, a) => sum + (parseInt(a.value) || 0), 0);

            let newActivityScore = Math.min(100, 85 + Math.floor(totalSteps / 10000));
            const mindfulCount = mockActivities.filter(a => a.metric === 'MEDITATION').length;
            let newStressScore = Math.min(100, 79 + (mindfulCount * 5));

            healthScores.activity = newActivityScore;
            healthScores.stress = newStressScore;

            const totalScore = (healthScores.activity + healthScores.sleep + healthScores.stress + healthScores.nutrition) / 4;
            const roundedScore = Math.round(totalScore);

            const overallScoreEl = document.getElementById('overall-score');
            if (overallScoreEl) overallScoreEl.textContent = roundedScore;

            const scoreEls = {
                'score-activity': healthScores.activity,
                'score-sleep': healthScores.sleep,
                'score-stress': healthScores.stress,
                'score-nutrition': healthScores.nutrition
            };

            Object.entries(scoreEls).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });

            const homeScoreDisplay = document.getElementById('home-score-display');
            if (homeScoreDisplay) homeScoreDisplay.textContent = `${roundedScore}/100`;

            renderGoalsAndActivities();
            renderDashboardChart();
        }

        function checkAuthAndShowDashboard() {
            const prompt = document.getElementById('dashboard-auth-prompt');
            const content = document.getElementById('dashboard-content');

            if (isLoggedIn) {
                prompt?.classList.add('hidden');
                content?.classList.remove('hidden');
                // Refresh all dynamic data
                setTimeout(() => {
                    calculateAndRenderScores();
                    renderGoalsAndActivities();
                    renderMedications();
                }, 100);
            } else {
                prompt?.classList.remove('hidden');
                content?.classList.add('hidden');
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderGoalsAndActivities() {
            const goalsContainer = document.querySelector('#dashboard-content .card:nth-child(2) .space-y-4');
            if (goalsContainer) {
                goalsContainer.innerHTML = mockGoals.map(goal => {
                    const percentage = (goal.current / goal.target) * 100;
                    const width = Math.min(100, percentage);
                    const color = percentage >= 100 ? 'bg-green-500' : 'color-bg-accent';
                    const textColor = 'color-accent-text';

                    return `
                <div>
                    <div class="flex justify-between items-center text-sm mb-1">
                        <span class="font-medium" style="color: var(--text-primary);">${goal.name}</span>
                        <span class="${textColor} font-bold">${goal.type === 'Sleep' ? `${goal.current}h 15m` : `${Math.floor(percentage)}%`}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div class="${color} h-2.5 rounded-full transition-all duration-500" style="width: ${width}%"></div>
                    </div>
                </div>
            `;
                }).join('');
            }

            const activityFeed = document.querySelector('#dashboard-content .card:nth-child(3) ul.space-y-3');
            if (activityFeed) {
                activityFeed.innerHTML = mockActivities.slice().reverse().slice(0, 3).map(activity => {
                    let icon, label, time, color;

                    const activityMeta = {
                        'STEPS': { icon: 'footprints', time: '4 hours ago', color: 'text-green-400' },
                        'WEIGHT': { icon: 'scale', time: '5 hours ago', color: 'text-yellow-400' },
                        'SLEEP': { icon: 'moon', time: '4 hours ago', color: 'text-indigo-400' },
                        'BP': { icon: 'heart-pulse', time: 'Yesterday', color: 'text-red-400' },
                        'MEDITATION': { icon: 'lotus', time: 'Just Now', color: 'text-pink-400' },
                        'NUTRITION': { icon: 'apple', time: 'Just Now', color: 'color-accent-text' },
                        'WORKOUT': { icon: 'dumbbell', time: 'Just Now', color: 'color-accent-text' }
                    };

                    const meta = activityMeta[activity.metric] || { icon: 'bolt', time: 'Just Now', color: 'text-white' };
                    icon = meta.icon;
                    time = meta.time;
                    color = meta.color;
                    label = `Logged ${activity.metric}: ${activity.value}.`;

                    return `
                <li class="flex items-center space-x-3 text-sm">
                    <i data-lucide="${icon}" class="w-5 h-5 ${color}"></i>
                    <span class="flex-1" style="color: var(--text-primary);">${label}</span>
                    <span class="text-xs text-gray-400">${time}</span>
                </li>
            `;
                }).join('');
            }

            const activityDot = document.getElementById('activity-dot');
            if (activityDot) {
                if (mockActivities.length > 3 || hasNewActivity) {
                    activityDot.classList.remove('hidden');
                    activityDot.classList.add('activity-dot');
                } else {
                    activityDot.classList.add('hidden');
                    activityDot.classList.remove('activity-dot');
                }
            }

            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        function renderDashboardChart() {
            const ctx = document.getElementById('weeklyPerformanceChart');
            if (!ctx) return;

            if (dashboardChartInstance) {
                dashboardChartInstance.destroy();
                dashboardChartInstance = null;
            }

            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
            const gridColor = currentTheme === 'dark' ? '#2d333b' : '#e5e7eb';

            const data = {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    {
                        label: 'Steps (x1000)',
                        data: [8, 12, 10, 15, 9, 11, 14],
                        backgroundColor: accentColor,
                        borderColor: accentColor,
                        yAxisID: 'y',
                        tension: 0.3,
                        type: 'bar',
                        borderRadius: 5
                    },
                    {
                        label: 'Sleep Quality (%)',
                        data: [85, 90, 80, 75, 95, 88, 92],
                        backgroundColor: '#a78bfa',
                        borderColor: '#a78bfa',
                        yAxisID: 'y1',
                        tension: 0.4,
                        pointRadius: 5,
                        type: 'line'
                    }
                ]
            };

            dashboardChartInstance = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Steps (x1000)', color: accentColor },
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Sleep Quality (%)', color: '#a78bfa' },
                            grid: { drawOnChartArea: false, color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: textColor } },
                        tooltip: {
                            backgroundColor: currentTheme === 'dark' ? '#1f2937' : '#ffffff',
                            titleColor: currentTheme === 'dark' ? '#fff' : '#1f2937',
                            bodyColor: textColor,
                            borderColor: accentColor,
                            borderWidth: 1
                        },
                        title: {
                            display: true,
                            text: 'Weekly Health Trend',
                            color: textColor
                        }
                    }
                },
            });
        }

        function renderPlannerChart(plannerType) {
            const ctx = document.getElementById('longTermChart');
            if (!ctx) return;

            if (plannerChartInstance) {
                plannerChartInstance.destroy();
                plannerChartInstance = null;
            }

            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
            const gridColor = currentTheme === 'dark' ? '#2d333b' : '#e5e7eb';

            const dataLabel = plannerType === 'Nutrition' ? 'Weight (kg)' : 'Strength Score (RM)';
            const chartData = plannerType === 'Nutrition'
                ? [85, 84.5, 83, 83.5, 82, 81.5, 80.8, 80]
                : [50, 55, 60, 65, 63, 70, 75, 80];
            const chartColor = plannerType === 'Nutrition' ? accentColor : '#a78bfa';

            plannerChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7', 'Week 8'],
                    datasets: [{
                        label: dataLabel,
                        data: chartData,
                        borderColor: chartColor,
                        backgroundColor: chartColor + '40',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: currentTheme === 'dark' ? '#161b22' : '#ffffff',
                        pointBorderColor: chartColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: dataLabel,
                                color: textColor
                            },
                            grid: {
                                color: gridColor,
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: textColor
                            }
                        },
                        title: {
                            display: true,
                            text: plannerType === 'Nutrition' ? '8-Week Weight Progress' : '8-Week Strength Progression',
                            color: textColor
                        },
                        tooltip: {
                            backgroundColor: currentTheme === 'dark' ? '#1f2937' : '#ffffff',
                            titleColor: currentTheme === 'dark' ? '#fff' : '#1f2937',
                            bodyColor: textColor,
                            borderColor: accentColor,
                            borderWidth: 1
                        },
                    }
                }
            });
        }

        // =======================================================
        // 7. VIEW MANAGEMENT
        // =======================================================

        function showView(viewId) {
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.remove('active'));

            const targetView = document.getElementById(viewId + '-view');
            if (targetView) {
                targetView.classList.add('active');
                window.scrollTo(0, 0);
                history.pushState({ view: viewId }, '', '/' + (viewId === 'home' ? '' : viewId));
            }

            // This line is crucial
            if (viewId === 'dashboard') {
                checkAuthAndShowDashboard();
            }

            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }

            if (viewId !== 'dashboard') {
                hasNewActivity = false;
                renderGoalsAndActivities();
            }

            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        // =======================================================
        // 8. MODAL FUNCTIONS
        // =======================================================

        function showModal(title, message, buttonText = 'Close', modalClass = 'modal-content', onConfirm = null) {
            const modalContent = document.getElementById('universal-modal-content');
            if (!modalContent) return;

            modalContent.className = '';
            modalContent.classList.add(modalClass.includes('modal-content') ? 'modal-content' : modalClass);

            let buttonHtml = `<button onclick="hideModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">${buttonText}</button>`;

            if (onConfirm) {
                const confirmButtonClass = buttonText.toLowerCase().includes('delete') ? 'bg-red-600 hover:bg-red-700 text-white' : 'color-bg-accent color-bg-accent-hover text-black';
                buttonHtml = `<button onclick="hideModal(); ${onConfirm}()" class="${confirmButtonClass} font-bold py-2 px-4 rounded-lg transition duration-150 mr-3">${buttonText}</button>`;
                buttonHtml += `<button onclick="hideModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">Cancel</button>`;
            }

            modalContent.innerHTML = `
        <button onclick="hideModal()" class="float-right text-gray-400 hover:text-white text-3xl leading-none" aria-label="Close modal">&times;</button>
        <h3 class="text-2xl font-bold mb-3" style="color: var(--text-primary);">${title}</h3>
        <p class="text-gray-400 mb-6">${message}</p>
        <div class="flex justify-end">
            ${buttonHtml}
        </div>
    `;
            const backdrop = document.getElementById('universal-modal-backdrop');
            if (backdrop) backdrop.style.display = 'flex';
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        function hideModal() {
            const backdrop = document.getElementById('universal-modal-backdrop');
            if (backdrop) backdrop.style.display = 'none';
        }

        function showSettingsModal() {
            const themeIcon = currentTheme === 'dark' ? 'sun' : 'moon';
            const themeLabel = currentTheme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
            const content = `
        <button onclick="hideModal()" class="float-right text-gray-400 hover:text-white text-3xl leading-none" aria-label="Close settings modal">&times;</button>
        <h3 class="text-2xl font-bold mb-4" style="color: var(--text-primary);"><i data-lucide="settings" class="w-7 h-7 color-accent-text mr-2"></i><span>App Settings</span></h3>
        <p class="text-gray-400 mb-6">General, data, and privacy features for a personalized experience.</p>

        <div class="space-y-4">
            <div class="p-3 bg-gray-800 rounded-lg">
                <h4 class="font-bold mb-2 flex items-center space-x-2" style="color: var(--text-primary);"><i data-lucide="paint-roller" class="w-5 h-5 text-purple-400"></i><span>Appearance</span></h4>
                <div class="space-y-2 text-sm text-gray-400">
                    <button onclick="toggleTheme()" class="w-full text-left p-2 rounded-lg bg-gray-700 hover:bg-gray-600 flex justify-between items-center text-white font-semibold">
                        <span>${themeLabel}</span>
                        <i data-lucide="${themeIcon}" class="w-5 h-5"></i>
                    </button>
                    <div class="flex justify-between items-center">
                        <span>Color Accent</span>
                        <select onchange="applyAccentColor(this.value)" class="bg-gray-700 border border-gray-600 rounded-lg p-1 text-xs text-white focus:ring-accent-teal">
                            <option value="Teal" ${getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() === '#2dd4bf' ? 'selected' : ''}>Teal (Default)</option>
                            <option value="Indigo" ${getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() === '#818cf8' ? 'selected' : ''}>Indigo</option>
                            <option value="Pink" ${getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() === '#f472b6' ? 'selected' : ''}>Pink</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="p-3 bg-gray-800 rounded-lg">
                <h4 class="font-bold mb-2 flex items-center space-x-2" style="color: var(--text-primary);"><i data-lucide="database" class="w-5 h-5 text-red-400"></i><span>Data & Privacy</span></h4>
                <div class="space-y-2 text-sm text-gray-400">
                    <button onclick="hideModal(); showDataPermissionsModal()" class="w-full text-left p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white">
                        Manage Data Permissions
                    </button>
                    <button onclick="hideModal(); showDataExportModal()" class="w-full text-left p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white">
                        Export All Health Data
                    </button>
                    <button onclick="showModal('Erase Data', 'This will permanently delete ALL your health data. Are you absolutely sure?', 'Delete All', 'modal-content', 'eraseAllData')" class="w-full text-left p-2 rounded-lg bg-red-800 hover:bg-red-700 text-red-300 font-bold">
                        Erase All Data
                    </button>
                </div>
            </div>

            <button onclick="hideModal(); showDeviceLinkModal()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 rounded-lg transition duration-150 flex items-center justify-center space-x-2">
                <i data-lucide="watch" class="w-5 h-5"></i>
                <span>Connect/Manage Smart Device</span>
            </button>
        </div>
    `;
            const modalContent = document.getElementById('universal-modal-content');
            if (modalContent) {
                modalContent.innerHTML = content;
                modalContent.classList.remove('modal-lg');
                document.getElementById('universal-modal-backdrop').style.display = 'flex';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        }

        // =======================================================
        // 9. AUTH FUNCTIONS (LOGIN/SIGNUP)
        // =======================================================

        async function loginUser(event) {
            event.preventDefault();
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');

            if (!emailInput || !passwordInput) return;

            const email = emailInput.value.trim().toLowerCase();
            const password = passwordInput.value;

            if (!email || !password) {
                showModal('Error', 'Enter email and password', 'OK');
                return;
            }

            const btn = event.target.querySelector('button[type="submit"]');
            if (!btn) return;

            const old = btn.innerHTML;
            btn.innerHTML = 'Logging in...';
            btn.disabled = true;

            try {
                const res = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok && data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    loggedInUser = data.user.name || email.split('@')[0];
                    setLoggedIn(true, loggedInUser);
                    hideAuthModal();
                    showView('dashboard');
                    showModal('Welcome!', `Hey ${loggedInUser}! 👋`, 'Go to Dashboard');
                } else {
                    throw new Error(data.message || 'Login failed');
                }
            } catch (err) {
                showModal('Login Failed', err.message, 'Try Again');
            } finally {
                btn.innerHTML = old;
                btn.disabled = false;
            }
        }

        async function signUpUser(event) {
            event.preventDefault();
            const emailInput = document.getElementById('signup-email');
            const passwordInput = document.getElementById('signup-password');

            if (!emailInput || !passwordInput) return;

            const email = emailInput.value.trim().toLowerCase();
            const password = passwordInput.value;

            if (!email || password.length < 8) {
                showModal('Invalid', 'Valid email + 8+ char password required', 'OK');
                return;
            }

            const btn = event.target.querySelector('button[type="submit"]');
            if (!btn) return;

            const old = btn.innerHTML;
            btn.innerHTML = 'Creating...';
            btn.disabled = true;

            try {
                const res = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok && data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    loggedInUser = email.split('@')[0];
                    setLoggedIn(true, loggedInUser);
                    hideAuthModal();
                    showView('dashboard');
                    showModal('Welcome to PULSE! 🎉', 'Your health journey starts now.', 'Start Tracking');
                } else {
                    throw new Error(data.message || 'Signup failed');
                }
            } catch (err) {
                showModal('Error', err.message, 'OK');
            } finally {
                btn.innerHTML = old;
                btn.disabled = false;
            }
        }

        function setLoggedIn(status, username = '') {
            isLoggedIn = status;
            loggedInUser = username || loggedInUser;
            updateHeaderAuthDisplay();
            if (!status) {
                showView('home');
            }
        }

        // =======================================================
        // 10. DATA MANAGEMENT FUNCTIONS
        // =======================================================

        function showManualDataModal() {
            const content = `
        <button onclick="hideModal()" class="float-right text-gray-400 hover:text-white text-3xl leading-none" aria-label="Close manual data modal">&times;</button>
        <h3 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">Manual Data Entry</h3>
        <form onsubmit="submitManualData(event)" class="space-y-4">
            <div class="input-group">
                <label for="metric" class="block text-sm font-medium mb-1">Metric</label>
                <i data-lucide="gauge" class="w-5 h-5"></i>
                <select id="metric" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-[var(--accent-color)]" required>
                    <option value="steps">Steps Count</option>
                    <option value="weight">Weight (kg)</option>
                    <option value="sleep">Sleep Duration (hours)</option>
                    <option value="bp">Blood Pressure (systolic/diastolic)</option>
                    <option value="sugar">Blood Sugar (mg/dL)</option>
                    <option value="mindfulness">Mindfulness/Meditation (minutes)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="value" class="block text-sm font-medium mb-1">Value</label>
                <i data-lucide="hash" class="w-5 h-5"></i>
                <input type="text" id="value" placeholder="Enter value(s) (e.g., 105/70 for BP)" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-[var(--accent-color)]" required>
            </div>
            <button type="submit" class="w-full color-bg-accent color-bg-accent-hover text-black font-bold py-2.5 rounded-lg transition duration-150">Submit Data</button>
        </form>
    `;
            const modalContent = document.getElementById('universal-modal-content');
            if (modalContent) {
                modalContent.innerHTML = content;
                modalContent.classList.remove('modal-lg');
                document.getElementById('universal-modal-backdrop').style.display = 'flex';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        }

        function submitManualData(event) {
            if (event) event.preventDefault();

            const metricInput = document.getElementById('metric');
            const valueInput = document.getElementById('value');

            if (!metricInput || !valueInput) return;

            const metricValue = metricInput.value;
            const value = valueInput.value;

            let activityType, metricName;

            const metricMap = {
                'steps': { type: 'Activity', name: 'STEPS' },
                'weight': { type: 'Activity', name: 'WEIGHT' },
                'sleep': { type: 'Sleep', name: 'SLEEP' },
                'mindfulness': { type: 'Mindfulness', name: 'MEDITATION' }
            };

            if (metricMap[metricValue]) {
                activityType = metricMap[metricValue].type;
                metricName = metricMap[metricValue].name;
            } else {
                activityType = 'Health';
                metricName = metricValue.toUpperCase();
            }

            mockActivities.push({
                id: nextActivityId++,
                metric: metricName,
                value: value,
                date: new Date().toLocaleDateString(),
                type: activityType
            });

            hasNewActivity = true;

            hideModal();
            showModal('Data Added', `Successfully logged **${value}** for **${metricName}**. Your dashboard is updating.`, 'View Dashboard');

            calculateAndRenderScores();
        }

        function eraseAllData() {
            mockActivities.length = 0;
            mockGoals.length = 0;
            mockMedications.length = 0;
            nextActivityId = 1;
            nextGoalId = 1;
            nextMedicationId = 101;
            healthScores = { activity: 50, sleep: 50, stress: 50, nutrition: 50 };
            isLoggedIn = false;
            loggedInUser = '';

            updateHeaderAuthDisplay();
            calculateAndRenderScores();
            showView('home');
            showModal('Data Erased', 'All personalized data has been permanently deleted. Your privacy is secured.', 'Restart App');
        }

        // =======================================================
        // 11. PLANNER FUNCTIONS
        // =======================================================

        function openPlanner(plannerName) {
            if (plannerName === 'Content Library') {
                showModal('Content Library', 'Accessing the curated library of health articles and videos verified by experts. This takes you to our blog and resources section.', 'Browse Content');
                return;
            }

            const titleElement = document.getElementById('planner-title');
            const tasksElement = document.getElementById('planner-tasks');
            const addTaskButton = document.getElementById('add-task-button');
            const aiToolsCard = document.getElementById('ai-planner-tools-card');

            if (!titleElement || !tasksElement || !addTaskButton || !aiToolsCard) return;

            const plannerCardIcon = plannerName === 'Nutrition' ? 'apple' : 'activity';

            titleElement.innerHTML = `<i data-lucide="${plannerCardIcon}" class="w-9 h-9 mr-3"></i> ${plannerName} Planner`;
            addTaskButton.setAttribute('onclick', `showPlannerLogModal('${plannerName}')`);

            let aiToolsHtml = '';
            if (plannerName === 'Nutrition') {
                aiToolsHtml = `
            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                <i data-lucide="scan" class="w-6 h-6 text-yellow-400"></i>
                <span>AI Meal Generation & Calorie Check</span>
            </h3>
            <p class="text-sm text-gray-400 mb-4">Generate 3 healthy meal ideas based on your calorie target (1800 kcal) and existing restrictions (Vegetarian, Low-Sodium).</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="aiPlannerAction('Generate Meal')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                    Generate 3-Day Meal Plan
                </button>
                <button onclick="aiPlannerAction('Calorie Check')" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                    Calorie/Macro Audit
                </button>
            </div>
        `;
            } else if (plannerName === 'Workout') {
                aiToolsHtml = `
            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                <i data-lucide="activity" class="w-6 h-6 text-yellow-400"></i>
                <span>AI Workout Optimization</span>
            </h3>
            <p class="text-sm text-gray-400 mb-4">Analyze your recent performance data to suggest optimal weight, reps, and rest times for your next session (Target: Strength Gain).</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="aiPlannerAction('Optimize Workout')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                    Optimize Today's Routine
                </button>
                <button onclick="aiPlannerAction('Injury Prevention')" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded-lg transition duration-150 transform hover:scale-[1.01]">
                    Injury Risk Assessment
                </button>
            </div>
        `;
            }
            aiToolsCard.innerHTML = aiToolsHtml;

            const tasks = plannerName === 'Nutrition' ? NUTRITION_TASKS : WORKOUT_TASKS;
            tasksElement.innerHTML = tasks.map((task, index) => `
        <li class="flex items-center space-x-3 text-sm p-2 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition duration-150">
            <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion('${plannerName}', ${index})" class="h-4 w-4 rounded border-gray-700 bg-gray-700 text-accent-teal focus:ring-[var(--accent-color)]">
            <i data-lucide="${task.icon}" class="w-5 h-5 ${task.completed ? 'text-green-500' : 'text-gray-400'}"></i>
            <span class="flex-1 ${task.completed ? 'line-through text-gray-500' : 'text-white'}">${task.name}</span>
        </li>
    `).join('');

            showView('planner');
            setTimeout(() => renderPlannerChart(plannerName), 100);

            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        function toggleTaskCompletion(plannerType, index) {
            const tasks = plannerType === 'Nutrition' ? NUTRITION_TASKS : WORKOUT_TASKS;
            if (tasks[index]) {
                tasks[index].completed = !tasks[index].completed;
                openPlanner(plannerType);
                showModal('Task Update', `Task marked as **${tasks[index].completed ? 'complete' : 'incomplete'}**. Good job!`, 'OK');
            }
        }

        function aiPlannerAction(action) {
            hideModal();
            showModal('AI Action', `AI is running a **${action}** task based on your preferences and data. Results will appear in the tasks list shortly.`, 'Processing...');
        }

        function showPlannerLogModal(plannerType) {
            const icon = plannerType === 'Nutrition' ? 'utensils' : 'dumbbell';
            const metric = plannerType === 'Nutrition' ? 'Meal/Food Item' : 'Exercise/Set Count';
            const placeholder = plannerType === 'Nutrition' ? 'e.g., Chicken Salad (450 kcal)' : 'e.g., 3x10 Squats (135 lbs)';

            const content = `
        <button onclick="hideModal()" class="float-right text-gray-400 hover:text-white text-3xl leading-none" aria-label="Close planner log modal">&times;</button>
        <h3 class="text-2xl font-bold mb-4 text-white">Log ${plannerType} Entry</h3>
        <form onsubmit="submitPlannerLog(event, '${plannerType}')" class="space-y-4">
            <div class="input-group">
                <label for="log-details" class="block text-sm font-medium mb-1">${metric}</label>
                <i data-lucide="book-open" class="w-5 h-5"></i>
                <input type="text" id="log-details" placeholder="${placeholder}" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-[var(--accent-color)]" required>
            </div>
            <div class="input-group">
                <label for="log-value" class="block text-sm font-medium mb-1">Value (e.g., 450 kcal, 45 min)</label>
                <i data-lucide="hash" class="w-5 h-5"></i>
                <input type="text" id="log-value" placeholder="Enter quantitative data" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:ring-[var(--accent-color)]" required>
            </div>
            <button type="submit" class="w-full color-bg-accent color-bg-accent-hover text-black font-bold py-2.5 rounded-lg transition duration-150 flex items-center justify-center space-x-2">
                <i data-lucide="${icon}" class="w-5 h-5"></i>
                <span>Log to Tracker</span>
            </button>
        </form>
    `;
            const modalContent = document.getElementById('universal-modal-content');
            if (modalContent) {
                modalContent.innerHTML = content;
                modalContent.classList.remove('modal-lg');
                document.getElementById('universal-modal-backdrop').style.display = 'flex';
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
        }

        function submitPlannerLog(event, plannerType) {
            if (event) event.preventDefault();

            const detailsInput = document.getElementById('log-details');
            const valueInput = document.getElementById('log-value');

            if (!detailsInput || !valueInput) return;

            const details = detailsInput.value;
            const value = valueInput.value;

            mockActivities.push({
                id: nextActivityId++,
                metric: plannerType.toUpperCase(),
                value: details,
                date: new Date().toLocaleDateString(),
                type: plannerType
            });

            hasNewActivity = true;

            hideModal();
            showModal('Log Successful', `Successfully logged "${details} (${value})" to your ${plannerType} tracker. Progress updated!`, 'Great!');

            calculateAndRenderScores();
            openPlanner(plannerType);
        }

        // =======================================================
        // 12. CHATBOT FUNCTIONS
        // =======================================================

        function showTypingIndicator() {
            const chatHistory = document.getElementById('chat-history');
            if (!chatHistory) return;

            const typingIndicator = `
        <div id="ai-typing-indicator" class="message ai-message">
            <div class="ai-typing">
                <i data-lucide="loader-2" class="w-4 h-4 mr-2"></i>
                <span>PULSE AI is typing...</span>
            </div>
        </div>
    `;
            chatHistory.insertAdjacentHTML('beforeend', typingIndicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('ai-typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function addMessage(text, sender) {
            const chatHistory = document.getElementById('chat-history');
            if (!chatHistory) return;

            const bubbleClass = sender === 'user' ? 'user-bubble' : 'ai-bubble';
            const messageClass = sender === 'user' ? 'user-message' : '';
            const messageHtml = `
        <div class="message ${messageClass}">
            <div class="${bubbleClass}">${text}</div>
        </div>
    `;
            chatHistory.insertAdjacentHTML('beforeend', messageHtml);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function sendChat(event, voiceInput = null) {
            if (event) event.preventDefault();

            const chatInput = document.getElementById('chat-input');
            if (!chatInput && !voiceInput) return;

            const userText = voiceInput || chatInput?.value.trim();
            if (!userText) return;

            addMessage(userText, 'user');
            if (chatInput) chatInput.value = '';

            if (!apiKey || apiKey === "YOUR_GEMINI_API_KEY_HERE") {
                removeTypingIndicator();
                addMessage("Please configure your Gemini API key to use the AI assistant.", 'ai');
                return;
            }

            showTypingIndicator();

            try {
                let contents = [{ parts: [{ text: userText }] }];
                if (base64ImageFile) {
                    contents = [{
                        role: "user",
                        parts: [
                            { text: userText },
                            {
                                inlineData: {
                                    mimeType: "image/png",
                                    data: base64ImageFile
                                }
                            }
                        ]
                    }];
                    base64ImageFile = null;
                }

                const overallScore = document.getElementById('overall-score');
                const payload = {
                    contents: contents,
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{
                            text: `You are PULSE AI, a friendly, knowledgeable, and privacy-conscious health assistant.
                    Your goal is to provide helpful, non-diagnostic guidance based on general knowledge and the user's mock health data (Wellness Score: ${overallScore?.textContent || 88}/100, Activity: ${healthScores.activity}, Stress: ${healthScores.stress}).
                    If the user asks for sensitive data or diagnosis, remind them to consult a medical professional. Keep responses concise and supportive.`
                        }]
                    },
                };

                const model = "gemini-2.0-flash-exp";
                const apiUrl = geminiUrl(model);

                const responseJson = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = responseJson.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let aiText = candidate.content.parts[0].text;
                    let sources = [];

                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);

                        if (sources.length > 0) {
                            aiText += "\n\n***\n**Sources:**\n";
                            sources.forEach((s, index) => {
                                aiText += `[${index + 1}. ${s.title}](${s.uri})\n`;
                            });
                        }
                    }

                    removeTypingIndicator();
                    addMessage(aiText, 'ai');

                } else {
                    removeTypingIndicator();
                    addMessage("I apologize, but I received an empty response. Please try again or rephrase your question.", 'ai');
                }

            } catch (error) {
                console.error("Gemini API call failed:", error);
                removeTypingIndicator();
                addMessage(`An error occurred while connecting to the AI assistant: ${error.message}. Please check your connection.`, 'ai');
            }
        }

        // =======================================================
        // 13. SPA ROUTING
        // =======================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Handle all navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = link.getAttribute('href').substring(1) || 'home';
                    showView(view);
                });
            });

            // Handle browser back/forward buttons
            window.addEventListener('popstate', (e) => {
                const state = e.state || {};
                const view = state.view || 'home';
                showView(view);
            });

            // Initial view on load
            const initialPath = window.location.pathname.substring(1) || 'home';
            const initialView = ['home', 'dashboard', 'planner', 'medications', 'wellness', 'chatbot'].includes(initialPath) ? initialPath : 'home';
            showView(initialView);

            // Initialize icons one final time
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });

        // =======================================================
        // 14. MEDICATION TRACKER FUNCTIONS
        // =======================================================
        function renderMedications() {
            const container = document.getElementById('medications-list');
            if (!container) return;

            container.innerHTML = mockMedications.map(med => {
                const isActive = med.status === 'Active';
                const adherenceClass = med.adherence >= 90 ? 'text-green-400' : med.adherence >= 70 ? 'text-yellow-400' : 'text-red-400';
                return `
            <div class="bg-gray-800/50 rounded-xl p-5 hover:bg-gray-800 transition duration-200">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="font-bold text-lg" style="color: var(--text-primary);">${med.name}</h4>
                    <span class="text-xs px-3 py-1 rounded-full ${isActive ? 'bg-green-900 text-green-300' : 'bg-gray-700 text-gray-400'}">
                        ${med.status}
                    </span>
                </div>
                <div class="space-y-2 text-sm text-gray-400">
                    <p><i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>${med.schedule}</p>
                    <p><i data-lucide="pill" class="w-4 h-4 inline mr-2"></i>Dosage: ${med.dosage} • ${med.frequency}</p>
                    <p><i data-lucide="trending-up" class="w-4 h-4 inline mr-2"></i>
                        Adherence: <span class="${adherenceClass} font-bold">${med.adherence}%</span>
                    </p>
                    ${isActive ? `<p class="text-pink-400 font-medium"><i data-lucide="bell" class="w-4 h-4 inline mr-2"></i>Next: ${med.nextDose}</p>` : ''}
                </div>
                ${isActive ? `
                <div class="mt-4 flex gap-2">
                    <button onclick="markDoseTaken(${med.id})" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm transition duration-150">
                        Mark Taken
                    </button>
                    <button onclick="snoozeDose(${med.id})" class="px-4 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm">
                        Snooze
                    </button>
                </div>` : ''}
            </div>
        `;
            }).join('');

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function markDoseTaken(id) {
            const med = mockMedications.find(m => m.id === id);
            if (med) {
                med.adherence = Math.min(100, med.adherence + 5);
                showModal('Dose Logged', `Great job taking your **${med.name.split(' (')[0]}** on time! Keep it up! 💊`, 'Done');
                renderMedications();
            }
        }

        function snoozeDose(id) {
            showModal('Dose Snoozed', 'Reminder snoozed for 30 minutes. Please remember to take your medication soon.', 'OK');
        }

        // Call on dashboard load or view change
        document.getElementById('medications-view')?.addEventListener('click', renderMedications);

        // =======================================================
        // 15. WELLNESS STUDIO PLACEHOLDERS
        // =======================================================
        function playBreathingExercise() {
            showModal('Breathing Exercise', 'Starting 4-7-8 breathing pattern...<br><br>Inhale for 4 seconds...<br>Hold for 7...<br>Exhale for 8...', 'Relaxing', 'modal-content', null);
            // In real app: trigger audio/visual guide
        }

        function startBodyScan() {
            showModal('Body Scan Starting', 'Lie down comfortably. We will guide you through a 5-minute progressive relaxation scan.', 'Begin');
        }

        // =======================================================
        // 16. FINAL INITIALIZATION CALLS
        // =======================================================
        document.addEventListener('DOMContentLoaded', () => {
            renderGoalsAndActivities();
            renderMedications();
            if (isLoggedIn) {
                checkAuthAndShowDashboard();
            }
        });
    </script>
</body>

</html>